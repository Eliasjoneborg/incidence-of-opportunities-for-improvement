---
title: "Incidence of Opportunities for Improvement"
subtitle: "a retrospective cohort study in a Scandinavian level-I trauma centre"
output:
  bookdown::pdf_document2:
    toc: false
bibliography: citations.bib
link-citations: yes
csl: bmcemerg.csl
header-includes:
  \usepackage{float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE }
#Necessary packages


library(dplyr)
library(plyr)
library(incidence)
library(scales)
library(ggplot2)
library(reshape2)
library(ggthemes)
library(DiagrammeR)
library(table1)
library(jtools)
library(ggstance)
library(lubridate)
library(grid)

library("keyring")
library("DBI")
library("RMariaDB")
library("readr")
library(dotenv)
library(devtools)
library(rofi)

conn <- DBI::dbConnect(drv = RMariaDB::MariaDB(),
                       user = "eliasj",
                      password = Sys.getenv("DB_PASSWORD"),
                      db = "opportunities_for_improvement")

dataset.names <- setNames(nm = c("swetrau", "fmp", "atgarder", "problem", "kvalgranskning2014.2017"))


datasets <- lapply(dataset.names, function(dataset.name) dbReadTable(conn = conn, name = dataset.name))

attach(datasets)

swetrau$arrival <- as.POSIXct(strptime(swetrau$DateTime_ArrivalAtHospital, format = "%Y-%m-%d %H:%M"))
fmp$arrival <- as.POSIXct(strptime(fmp$Ankomst_te, format = "%Y%m%d %H:%M"))
problem$arrival <- as.POSIXct(strptime(problem$Ankomst_te, format = "%Y%m%d %H:%M"))
swetrau$id <- paste(swetrau$arrival, swetrau$PersonIdentity, swetrau$TempIdentity)
fmp$id <- paste(fmp$arrival, fmp$Personnummer, fmp$Reservnummer)
problem$id <- paste(problem$arrival, problem$Personnummer, problem$Reservnummer)

## Combine datasets
combined.datasets <- merge(fmp, problem, by = "id", all.x = TRUE)
combined.datasets <- merge(combined.datasets, swetrau, by = "id", all.x = TRUE)
detach(datasets)
all_patients <-combined.datasets

combined.datasets <- filter(combined.datasets, as.Date(strptime(combined.datasets$Ankomst_te.x, format = "%Y%m%d %H:%M")) >="2017-01-01")


combined.datasets <- dplyr::rename(combined.datasets, "Fr1-14" = Fr1.14)

combined.datasets$OFI <- create_ofi(combined.datasets) 
 
datasets$kvalgranskning2014.2017$OFI <- with(datasets$kvalgranskning2014.2017, ifelse(problemområde == "Inget problemområde" | is.na(problemområde) | problemområde =="Nej", "No", "Yes"))

datasets$kvalgranskning2014.2017$arrival <- as.POSIXct(strptime(datasets$kvalgranskning2014.2017$DateTime_ArrivalAtHospital, format = "%Y-%m-%d %H:%M"))
                                                       
datasets$kvalgranskning2014.2017$id <- paste(datasets$kvalgranskning2014.2017$arrival, datasets$kvalgranskning2014.2017$pat_personnummer, datasets$kvalgranskning2014.2017$pat_TempPersonnummer)

combined.datasets <- merge(combined.datasets, datasets$kvalgranskning2014.2017, by = intersect(names(datasets$kvalgranskning2014.2017), names(combined.datasets)), all.x = TRUE)

sum(duplicated(combined.datasets$id))
sum(combined.datasets$OFI == "Yes")
swetrau_problem_merged <- combined.datasets

swetrau_problem_merged$OFI <- with(swetrau_problem_merged, ifelse(is.na(OFI) | OFI == "No", "No", "Yes")) 
known_problem_area <-swetrau_problem_merged[!is.na(swetrau_problem_merged$OFI),]
#remove unknown problem area

age_over_14 <- filter(known_problem_area, pt_age_yrs>14)

fewer_variables<-age_over_14 %>% select(id, inj_dominant, Problemomrade_.FMP, res_survival, pt_age_yrs, Gender, OFI, NISS, ed_gcs_sum, pre_intub_type, pre_sbp_value, pre_sbp_rtscat, ed_sbp_value, ed_sbp_rtscat, Ankomst_te.x, starts_with("AISCode"))
#removing unnecessary variables


## Changing 999 to NA for grouping into cohorts

fewer_variables$ed_sbp_value[fewer_variables$ed_sbp_value == 999] = NA
fewer_variables$ed_sbp_rtscat[fewer_variables$ed_sbp_rtscat == 999] = NA
fewer_variables$ed_gcs_sum[fewer_variables$ed_gcs_sum == 999] = NA
fewer_variables$ed_gcs_sum[fewer_variables$ed_gcs_sum == 99] = NA
fewer_variables$inj_dominant[fewer_variables$inj_dominant == 999] = NA

fewer_variables$Gender[fewer_variables$Gender == "M"] = "Male"
fewer_variables$Gender[fewer_variables$Gender == "K"] = "Female"


### COHORT GROUPING ###

## The functions below expect a row of AIS codes as input

#BLUNT MULTISYSTEM
is_serious <- function(code) {
  severity <- substr(as.character(code), 8, 8)
  as.numeric(severity) >= 3  
}
#if severity level is 3 or higher, the injury is considered serious

number_of_regions <- function(code) {
  region <- substr(as.character(code), 1, 1)
  length(unique(region))
}
#identifying number of regions

has_more_than_one_serious_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  number_of_regions(code[serious_injury]) >= 2
}

## combining them
blunt.multisystem <- apply(fewer_variables[1:100, ], 1, function(row) {
    code <- row[grep("AISCode", names(row))]
    row
})

fewer_variables$blunt_multisystem <- NA
#creating column blunt_multisystem

known_dominant_injury <-fewer_variables[!is.na(fewer_variables$inj_dominant), ] 
#removing not known in inj_dominant

for (i in 1:nrow(known_dominant_injury)) {
  v = 0+i
  if (has_more_than_one_serious_injury(known_dominant_injury[v,grepl( "AISCode" , names(known_dominant_injury))]) == TRUE && known_dominant_injury[v,"inj_dominant"] == 1) {
    known_dominant_injury[v,"blunt_multisystem"] <- TRUE
  } else {
    known_dominant_injury[v,"blunt_multisystem"] <- FALSE
  }
}
#blunt multisystem <- TRUE/FALSE 

## The above for loop could be replaced with the more R:ish apply function below, which is substantially faster (at least on my low performing machine)

known_dominant_injury$blunt_multisystem <- apply(known_dominant_injury, 1, function(row) {
    code <- row[grep("AISCode", names(row))] 
    has_more_than_one_serious_injury(code) && row["inj_dominant"] == "1"
})

#SHOCK
bp_is_na <- with(fewer_variables, is.na(ed_sbp_rtscat) & is.na(ed_sbp_value))    
known_blood_pressure <- fewer_variables[!bp_is_na,]  
#removing rows with na in both sbp value and rts
     
known_blood_pressure$ed_sbp_rtscat[is.na(known_blood_pressure$ed_sbp_rtscat)]<-10
known_blood_pressure$ed_sbp_value[is.na(known_blood_pressure$ed_sbp_value)]<-999
#an ineffective way to ensure I don't get na:s in "ed_sbp_below_90" column below

known_blood_pressure$ed_sbp_below_90 <- with(known_blood_pressure, ifelse(ed_sbp_value>=0 & known_blood_pressure$ed_sbp_value<=90, TRUE, FALSE))
known_blood_pressure$shock <- with(known_blood_pressure, ifelse(ed_sbp_below_90 == TRUE | ed_sbp_rtscat <= 3, TRUE, FALSE))
#creating column for bp<90 with TRUE/FALSE

known_blood_pressure$ed_sbp_value[(known_blood_pressure$ed_sbp_value == 999 )]<-NA

#GERIATRIC
known_age <- fewer_variables
known_age$geriatric <- with(fewer_variables, ifelse(pt_age_yrs>65, TRUE, FALSE))
#creating column in new df with TRUE/FALSE

#PENETRATING
neck_chest_abdomen_region <- function(code) {
  code <- code[!is.na(code)]
  region <- substr(as.character(code), 1, 1)  
  is.element(region,3:5)
}
#generates TRUE/FALSE

serious_neck_chest_abdomen_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  sum(neck_chest_abdomen_region(code[serious_injury]) == TRUE )
}
#generates numerical value

known_dominant_injury_pen <-fewer_variables[!is.na(fewer_variables$inj_dominant), ] 
known_dominant_injury_pen$penetrating <- NA
#removing na in dominant injury, new df

for (i in 1:nrow(known_dominant_injury_pen)) {
  v = 0+i
  if(serious_neck_chest_abdomen_injury(known_dominant_injury_pen[v,grepl( "AISCode" , names(known_dominant_injury_pen))]) >= 1 && known_dominant_injury_pen[v, "inj_dominant"] == 2) {
    known_dominant_injury_pen[v,"penetrating"] <- TRUE
  } else {
    known_dominant_injury_pen[v,"penetrating"] <- FALSE
  }
}
#penetrating <- TRUE/FALSE


#SEVERE TBI
head_region <- function(code) {
  region <- substr(as.character(code), 1, 1)
  is.element(region, 1)
}

#returns true if body region == 1

has_a_serious_head_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  head_region(code[serious_injury]) 
}

#acts on vectors in "serious_injury", chooses those which have region == 1

only_one_region <- function(code){
  number_of_regions(code) == 1
}

#generates TRUE/FALSE

only_one_serious_injury_region <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  only_one_region(code[serious_injury])
}
#generates TRUE/FALSE

gcs_and_intub_is_na <- with(fewer_variables, is.na(ed_gcs_sum) & is.na(pre_intub_type))    
known_gcs_or_intub_type <- fewer_variables[!gcs_and_intub_is_na,]  
#remove row if na in both prehospital intub type and gcs

known_gcs_or_intub_type$gcs_below_9 <- NA

known_gcs_or_intub_type$gcs_below_9 <- with(known_gcs_or_intub_type, ifelse(ed_gcs_sum<=8 | pre_intub_type==1, TRUE, FALSE))
known_gcs_or_intub_type$gcs_below_9 <- with(known_gcs_or_intub_type, ifelse(is.na(gcs_below_9) | isFALSE(gcs_below_9), FALSE, TRUE))

#makes new variable containing those with a GCS <9 and those intubated in a prehospital setting. Converts na to false

known_gcs_or_intub_type$severe_tbi <- NA

for (i in 1:nrow(known_gcs_or_intub_type)) {
  v = 0+i
if (has_a_serious_head_injury(known_gcs_or_intub_type[v, grepl("AISCode", names(known_gcs_or_intub_type))]) == TRUE && only_one_serious_injury_region(known_gcs_or_intub_type[v, grepl("AISCode", names(known_gcs_or_intub_type))]) == TRUE && known_gcs_or_intub_type[v, "gcs_below_9"] == TRUE) {
    known_gcs_or_intub_type[v,"severe_tbi"] <- TRUE
  } else {
    known_gcs_or_intub_type[v,"severe_tbi"] <- FALSE
  }
}


#### MERGING 

blunt_multisystem_cohort <- filter(known_dominant_injury, blunt_multisystem == "TRUE")
shock_cohort <- filter(known_blood_pressure, shock == "TRUE")
penetrating_cohort <- filter(known_dominant_injury_pen, penetrating == "TRUE")
geriatric_cohort <- filter(known_age, geriatric == "TRUE")
severe_tbi_cohort <-filter(known_gcs_or_intub_type, severe_tbi == "TRUE")
overall <- fewer_variables
#creating cohort df:s

 geriatric_cohort$Cohort <- "Geriatric"
 penetrating_cohort$Cohort <- "Penetrating"
 severe_tbi_cohort$Cohort <- "Severe TBI"
 shock_cohort$Cohort <- "Shock"
 blunt_multisystem_cohort$Cohort <- "Blunt multisystem"
 overall$Cohort <- "Overall"
 #creating common variable "cohort"
 
  merged_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(geriatric_cohort, penetrating_cohort, blunt_multisystem_cohort, shock_cohort, severe_tbi_cohort, overall))

  #merging cohorts

  
  
  
#### PLOTTING
  
  ## FLOWCHARTS                  
            
  
  
                  
  #SweTrau to M&M                
                  
 swetrau_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot]

# node definitions with substituted label text
node [shape = rectangle, width = 4, fillcolor = Biege]
a [label = '@@1']
b [label = '@@2']
d [label = '@@3']
e [label = '@@4']
g [label = '@@5']
h [label = '@@6']
i [label = '@@7']
j [label = '@@8']

a -> b
b -> d
d -> h [style = dotted label='Audit filter trigger or suspected OFI']
d -> g [style = dotted label='In need of second opinion']
d -> e [style = dotted label='No audit filter trigger and no suspected OFI']
g -> e
g -> h
h -> i
i -> j

}

[1]: paste0('Trauma team activation following major trauma')
[2]: paste0('Inclusion in SweTrau')
[3]: paste0('Primary nursing review')
[4]: paste0('Exclusion')
[5]: paste0('Secondary nursing review')
[6]: paste0('Multidisciplinary mortality and morbidity conference')
[7]: paste0('Consensus regarding existence of OFI')
[8]: paste0('Documentation in KUH TCQD')
") %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% rsvg::rsvg_pdf("swetrau_flowchart.pdf")                
  
#Stages of exclusion  
                        
   a <- c(0,1)               
   a$a <- nrow(datasets$problem) 
   a <- as.data.frame(a)
   a$b <- nrow(known_problem_area)
   a$c <- nrow(age_over_14)
   a$d <- nrow(fewer_variables)
   a$e <- nrow(blunt_multisystem_cohort)
   a$f <- nrow(penetrating_cohort)
   a$g <- nrow(severe_tbi_cohort)
   a$h <- nrow(geriatric_cohort)
   a$i <- nrow(shock_cohort)
   a$j <- nrow(problem) - nrow(known_problem_area)
            
  #df with nrow of relevant df:s to be used as reference in code below 
   
exclusion_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot, size=30, ranksep = 2 nodesep = 2]

node [shape = rectangle, height = 2, width = 12, fillcolor = Biege, fontsize = 50, penwidth =6, arrowsize = .5, weight = 2]
a [label = '@@1']
b [label = '@@2']
d [label = '@@3', arrowhead = none]
e [label = '@@4']
f [label = '@@5']
g [label = '@@6']
h [label = '@@7']
i [label = '@@8']
j [label = '@@9']
k [label = '@@10']
l [label = '@@11']
m [label = '@@12']

a -> b 
a -> j
b -> l
b -> k
l ->m
l -> d
d-> {e f g h i}


{ rank = same; a; j }
{ rank = same; b; k }
{ rank = same; l; m }
 
          
}

[1]: paste0('Trauma care quality database (n = ', a$a, ')')
[2]: paste0('Complete OFI data (n = ', a$b, ')')
[3]: paste0('Eligible for grouping stage (n = ', a$d, ')')
[4]: paste0('Blunt multisystem (n = ', a$e, ')')
[5]: paste0('Penetrating (n = ', a$f, ')')
[6]: paste0('Severe TBI (n = ', a$g, ')')
[7]: paste0('Shock (n = ', a$i, ')')
[8]: paste0('Geriatric (n = ', a$h, ')')
[9]: paste0('ED arrival prior to 2017 (n = ', a$j, ')')
[10]: paste0('Missing age data (n=932)')
[11]: paste0('Complete age data (n=5216)')
[12]: paste0('Age<15 (n=2)')
", height = "500") %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% rsvg::rsvg_pdf("exclusion_flowchart.pdf")   



#### GROUPING AND EXCLUSION TABLE
   
Cohort <- c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock", "Geriatric")
Category <- c("Dominant injury type", "Dominant injury type", "ED GCS", "ED SBP", "Age")
Missing <- c((nrow(fewer_variables)-nrow(known_dominant_injury)),(nrow(fewer_variables)-nrow(known_dominant_injury)), (nrow(fewer_variables)-nrow(known_gcs_or_intub_type)), (nrow(fewer_variables)-nrow(known_blood_pressure)), (nrow(fewer_variables)-nrow(known_age)))
Missing_as_percent <- c( round(((nrow(fewer_variables)-nrow(known_dominant_injury))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_dominant_injury))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_gcs_or_intub_type))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_blood_pressure))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_age))/nrow(fewer_variables)*100), digits = 2))
   
Exclusion_table <- data.frame(Cohort, Category, Missing, Missing_as_percent)
Exclusion_table


table(merged_cohorts$ed_gcs_sum)
 #### PATIENT DEMOGRAPHICS 

                  merged_cohorts$res_survival <- with(merged_cohorts, ifelse(res_survival== "1", "Dead", "Alive"))
                  merged_cohorts$NISS<- as.numeric(merged_cohorts$NISS)
                  render.continuous.default(merged_cohorts$NISS)
                  merged_cohorts$pt_age_yrs<- as.numeric(merged_cohorts$pt_age_yrs)
                  render.continuous.default(merged_cohorts$pt_age_yrs)
                  merged_cohorts$ed_gcs_sum<- as.numeric(merged_cohorts$ed_gcs_sum)
                  render.continuous.default(merged_cohorts$ed_gcs_sum)
  
                  label(merged_cohorts$NISS)              <- "NISS"
                  label(merged_cohorts$ed_sbp_value)     <- "ED SBP"
                  label(merged_cohorts$pt_age_yrs)        <- "Age"
                  label(merged_cohorts$ed_gcs_sum)        <- "ED GCS"
                  label(merged_cohorts$res_survival)        <- "Survival"
                  label(merged_cohorts$Gender)        <- "Sex"
                  
                  label(merged_cohorts$OFI)               <- "OFI"
                  
              
          
                          units(merged_cohorts$ed_sbp_value)   <- "mmHg"
                  units(merged_cohorts$pt_age_yrs)    <-"years"
                  

                  pt_demographics <- table1(~ OFI + pt_age_yrs + Gender + ed_gcs_sum  + ed_sbp_value + NISS + res_survival | Cohort, data=merged_cohorts, caption="\\textbf{Demographics}", overall = FALSE)
                  
                  
                  
      

#### INCIDENCE CALCULATIONS
   
                  
   fewer_variables$date <- as.Date(strptime(fewer_variables$Ankomst_te.x, format = "%Y%m%d %H:%M"))
#converting date               
                

### INCIDENCE (3-months)

cohorts <- list(geriatric_cohort = geriatric_cohort,
                 penetrating_cohort = penetrating_cohort,
                 blunt_multisystem_cohort = blunt_multisystem_cohort,
                 shock_cohort = shock_cohort,
                 severe_tbi_cohort = severe_tbi_cohort,
                 overall = overall)
 calculate_incidence <- function(cohort) {
     cohort$date <- as.Date(strptime(cohort$Ankomst_te.x, format = "%Y%m%d %H:%M"))
     cohort.ofi <- incidence(cohort$date, interval = "6 months", groups = cohort$OFI) %>% as.data.frame()
     cohort.ofi$incidence <- 0
     if (is.element("No", names(cohort.ofi)))
         cohort.ofi$incidence <- cohort.ofi$Yes / (cohort.ofi$Yes + cohort.ofi$No) * 100
     return (cohort.ofi)
 }
 incidence.data <- lapply(cohorts, calculate_incidence)


### CUMULATIVE INCIDENCE (year)

 calculate_percent_of_total <- function(cohort) {
     cohort$date <- as.Date(strptime(cohort$Ankomst_te.x, format = "%Y%m%d %H:%M"))
     cohort.ofi <- incidence(cohort$date, interval = "6 months", groups = cohort$OFI) %>% as.data.frame()
     cohort.ofi$per_tot <- 0
     if (is.element("No", names(cohort.ofi)))
         cohort.ofi$per_tot <- cohort.ofi$Yes / c(nrow(cohort)) * 100
     return (cohort.ofi)
 }
     
  percentage.data <- lapply(cohorts, calculate_percent_of_total)    
 
 get_cum_inc<- function(cohort){
cum_inc <- transform(cohort, cum_inc = cumsum(cohort$per_tot))
 return(cum_inc)
 }
 
cumulative.incidence.data <- lapply(percentage.data, get_cum_inc)
 




#### RENAMING VARIABLES

incidence_data <- incidence.data
incidence.data$geriatric_cohort$incidence_ger <- incidence.data$geriatric_cohort$incidence
incidence.data$penetrating_cohort$incidence_pen <- incidence.data$penetrating_cohort$incidence
incidence.data$severe_tbi_cohort$incidence_tbi <- incidence.data$severe_tbi_cohort$incidence
incidence.data$shock_cohort$incidence_sho <- incidence.data$shock_cohort$incidence
incidence.data$blunt_multisystem_cohort$incidence_blu <- incidence.data$blunt_multisystem_cohort$incidence
incidence.data$overall$incidence_all <- incidence.data$overall$incidence

#making unique variable name for each cohort (there surely is a way to do this more efficiently, but right now it is not my focus

cumulative.incidence.data$geriatric_cohort$cum_inc_ger <- cumulative.incidence.data$geriatric_cohort$cum_inc
cumulative.incidence.data$penetrating_cohort$cum_inc_pen <- cumulative.incidence.data$penetrating_cohort$cum_inc
cumulative.incidence.data$severe_tbi_cohort$cum_inc_tbi <- cumulative.incidence.data$severe_tbi_cohort$cum_inc
cumulative.incidence.data$shock_cohort$cum_inc_sho <- cumulative.incidence.data$shock_cohort$cum_inc
cumulative.incidence.data$blunt_multisystem_cohort$cum_inc_blu <- cumulative.incidence.data$blunt_multisystem_cohort$cum_inc
cumulative.incidence.data$overall$cum_inc_all <- cumulative.incidence.data$overall$cum_inc

#no2


cumulative.incidence.data <- bind_rows(cumulative.incidence.data, .id = NULL)
cumulative.incidence.data[is.na(cumulative.incidence.data)] = 0
cumulative.incidence.data<- ddply(cumulative.incidence.data,"dates",numcolwise(sum))
#list to df

incidence.data <- bind_rows(incidence.data, .id = NULL)
incidence.data[is.na(incidence.data)] = 0
incidence.data<- ddply(incidence.data,"dates",numcolwise(sum))
#list to df




#### PLOTTING INCIDENCE AND CUMULATIVE INCIDENCE

#Yearly incidence as %
plot_inc_year <- incidence.data %>% select(dates, incidence_blu, incidence_pen, incidence_tbi, incidence_sho, incidence_ger, incidence_all)

plot_inc_year_long <- melt(plot_inc_year, id.vars = "dates")
#melt as to enable ggplot to work

library(gridExtra)
library(grid)
library(ggthemes)

incidence_plot <- ggplot(plot_inc_year_long,
       aes(x=dates,
           y=value,
           col = variable)) + 
  scale_color_discrete(name = "Cohort", labels = c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock","Geriatric", "Overall")) +
  geom_line(size = 1.0, alpha = 1.0) +
  labs(x = "Year",
       y = "%") +
  theme_tufte() +
  theme(axis.title = element_text(), legend.title = element_blank()) 

#Right now not showing S-TBI cohort as there are missing values.


#Cumulative incidence
plot_cum_inc<-cumulative.incidence.data %>% select(dates, cum_inc_blu, cum_inc_pen, cum_inc_tbi, cum_inc_sho, cum_inc_ger, cum_inc_all)

plot_cum_inc_long <- reshape2::melt(plot_cum_inc, id.vars = "dates")

cum_incidence_plot<- ggplot(plot_cum_inc_long,
       aes(x=dates,
           y=value,
           col=variable)) +
     geom_point(size=2.0, shape = col) +
  scale_color_discrete(name = "Cohort", labels = c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock","Geriatric", "Overall")) +
  scale_shape_manual(name = "Cohort",
                     labels = c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock","Geriatric", "Overall"),
                     values = c(0, 1, 2, 3, 4, 5, 6)) +
  geom_line(size = 1.0, alpha = 1.0) +
  labs(x = "Year",
       y = "%") +
  theme_tufte() +
  theme(axis.title = element_text(), legend.title = element_blank())


#### INCIDENCE TRENDS

library(fable)
library(broom)
calculate_incidence_trends <- function(cohort) {
   trend <- as_tsibble(cohort) %>% model(lm = TSLM(incidence ~ trend())) %>% tidy()
     return (trend)
}

incidence.trends <- lapply(incidence_data, calculate_incidence_trends)


penetrating_incidence_trend <- incidence.trends$penetrating[c(2), ] 
geriatric_incidence_trend <- incidence.trends$geriatric[c(2), ] 
tbi_incidence_trend <- incidence.trends$severe_tbi[c(2), ] 
blunt_incidence_trend <- incidence.trends$blunt[c(2), ] 
shock_incidence_trend <- incidence.trends$shock[c(2), ] 
overall_incidence_trend <- incidence.trends$overall[c(2), ] 

penetrating_incidence_trend$cohort <- "Penetrating"
geriatric_incidence_trend$cohort <-"Geriatric"
tbi_incidence_trend$cohort <- "Severe TBI"
blunt_incidence_trend$cohort <- "Blunt multisystem"
shock_incidence_trend$cohort <- "Shock"
overall_incidence_trend$cohort <- "Overall"

incidence_trend_table <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(blunt_incidence_trend, penetrating_incidence_trend, tbi_incidence_trend, shock_incidence_trend, geriatric_incidence_trend, overall_incidence_trend))

library(dplyr)
library(readxl)

names(incidence_trend_table) <- c('Model', 'Term', 'Estimate', 'SD_error', 'Statistic', 
                       'P_value', 'Cohort')
incidence_trend_table <- incidence_trend_table[,c(7, 3, 4, 5, 6, 2, 1)]
incidence_trend_table <- incidence_trend_table[, -c(3,4,6,7)]

x <- c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock", "Geriatric", "Overall")
incidence_trend_table <- incidence_trend_table[c(6,5,1,2,4,3), ]
rownames(incidence_trend_table) <- c()


### INCIDENCE PACKAGE PLOT 


incidence_package_ofi <- incidence(fewer_variables$date, interval = "6 months", groups = fewer_variables$OFI)
#Use of incidence package to calculate incidence in the group as a whole by year (2)

plot(incidence_package_ofi, stack = TRUE, border = "grey")
### TOTAL

#calculate incidence by cohort and year (2)
cohort_incidence_package_ofi <- filter(merged_cohorts, OFI == "Yes")

cohort_incidence_package_ofi$date <-as.Date(strptime(cohort_incidence_package_ofi$Ankomst_te.x, format = "%Y%m%d %H:%M"))
#converting date

#Since each case here is "OFI == Yes", incidence of dates is all we need to calculate

cohort_incidence_package_ofi <-incidence(cohort_incidence_package_ofi$date, interval = "6 months", groups = cohort_incidence_package_ofi$Cohort)

incidence_package_plot <- plot(cohort_incidence_package_ofi)
### BY COHORT




#### REFERENCES FOR MARKDOWN CHUNKS

cum_inc <- select(plot_cum_inc, -dates)
cum_inc <- cum_inc %>% slice(-c(1:8))


incidence <- select(incidence.data, incidence_ger, incidence_pen, incidence_blu, incidence_sho, incidence_tbi)

min.col <- function(m, ...) max.col(-m, ...)


pt_demographics_flex<- t1flex(pt_demographics)

FitFlextableToPage <- function(ft, pgwidth = 6){
    ft_out <- ft %>% autofit()
      ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}


max_percent_dead <- c(nrow(filter(severe_tbi_cohort, res_survival == 1))) / c(nrow(severe_tbi_cohort)) * 100
second_max_percent_dead <- c(nrow(filter(shock_cohort, res_survival == 1))) / c(nrow(shock_cohort)) * 100

percent_male <- c(nrow(filter(fewer_variables, Gender == "Male"))) / c(nrow(fewer_variables)) * 100

# PROBLEM AREAS
# Riktigt klumpigt kodat mot slutet av denna chunk. Katastrofkodat under denna rubrik, men får jobbet gjort.

 
Problem_area <- data.frame(table(combined.datasets$Problemomrade_.FMP))
Problem_area <- Problem_area[-c(4, 13, 14, 15), ]
 Problem_area$problem_area <- c("Routine", "Documentation", "documentation", "Processing", "Communication", "Nursing and physician competency","Time to computed tomography", "Time to surgery", "Logistics and technique", "Injury identification", "Neurosurgical intervention", "Resource management", "Tertiary survey", "Trauma criteria and overall management", "Emergency department triage", "Hospital care level")
Problem_area <- Problem_area[, -c(1)]
Problem_area$percentage <- round(Problem_area$Freq/sum(Problem_area$Freq)*100, digits = 2)
Problem_area <- Problem_area %>% select(problem_area, Freq, percentage)

Problem_area[nrow(Problem_area) + 1,] <- c("Documentation", 4, 1.25)
Problem_area <- Problem_area[-c(2,3), ]
Problem_area$percentage <- as.numeric(Problem_area$percentage)

Problem_area <- arrange(Problem_area, desc(percentage))

problem_area_barplot <- ggplot(data=Problem_area, aes(x=reorder(problem_area, -percentage), y=percentage)) +
  geom_bar(stat="identity", fill= "skyblue"  ) +
  theme_tufte() +
   guides(x = guide_axis(angle = 90)) +
  labs(x = "", y = "%") +
  ylim(0, 25) 

#Blunt multisystem

Blunt_pa <- data.frame(table(blunt_multisystem_cohort$Problemomrade_.FMP))
Blunt_pa <- Blunt_pa[-c(7, 8, 9), ]
Blunt_pa$percentage <- round(Blunt_pa$Freq/sum(Blunt_pa$Freq)*100, digits = 2)
Blunt_pa <- Blunt_pa %>% select(Var1, Freq, percentage)
Blunt_pa <- arrange(Blunt_pa, desc(percentage))

Blunt_pa$Var1 <- c("Resource management", "Emergency department triage", "Time to surgery", "Hospital care level", "Injury identification", "Trauma criteria and overall management","Processing", "Time to computed tomography", "Communication", "Logistics and technique")

Blunt_pa_barplot <- ggplot(data=Blunt_pa, aes(x=reorder(Var1, -percentage), y=percentage)) +
  geom_bar(stat="identity", fill= "skyblue"  ) +
  theme_tufte() +
   guides(x = guide_axis(angle = 90)) +
  labs(x = "", y = "%") +
  ylim(0, 25) 
Blunt_pa_barplot

```


# Background

Trauma, defined as physical injury and the body’s associated response[@Gerdin2015], is the leading cause of death in patients aged 45 or younger[@GlobalStats]. For every death by trauma, three patients are rendered permanently disabled[@Trauma], which significantly amplifies the social and economic impacts of the disease as well as the importance of quality trauma care. The two major mechanisms of injury are blunt trauma, mainly due to falls, traffic accidents and assaults, and penetrating trauma, mainly due to stabbing or use of firearms[@Trauma].

In striving towards a high performing trauma care of uniform quality, most countries have structured trauma care similarly, adhering to certain guiding principles. Generally referred to as 'trauma systems', the structure typically involves: (i) centralization of trauma care to specialized trauma centres, (ii) benchmarking of outcomes through trauma registries and (iii) continuous retrospective assessment of care provided through multidisciplinary mortality and morbidity review board conferences. Following the widespread introduction of trauma systems, the prevalence of extensive institutional, regional and national trauma registries and review board records have increased greatly, as have the number of investigatory studies that constitute trauma epidemiology.

Historically within trauma epidemiology, much emphasis has been placed on benchmarking rates of mortality and morbidity and rates of death preventability [ref]. Continuous benchmarks of mortality and morbidity rates are essential to a well functioning quality improvement process. Rates of death preventability, however, constitutes a poor measure of care quality due to intrinsic problems in its review process, along with its poor external validity [ref:s]. A sound measure of care quality is nonetheless needed, as it allows for comparisons of care to be made, not only across institutions, but within institutions across the spectrum of disease.

In recent years, the term 'opportunities for improvement' in care provided (OFI) have emerged in the trauma literature, representing a coarse dichotomous proxy measure for care quality. OFI is defined as patient care disharmonious with the current best practice guidelines, and relies on a consensus decision by an expert review board. Rates of OFI constitutes a more accurate measure of care quality than rates of death preventability. Further, unequal distributions of OFI within different parts of the trauma population can help spotlight negative trends rectifiable by way of corrective intervention. Hitherto, no study has set out to estimate rates of OFI within the general Scandinavian trauma population.

## Aim
The aim of this study is to measure the incidence of OFI in care provided across different cohorts at KUH trauma centre, identify problem areas and estimate temporal incidence trends.

# Methods

## Study design
A retrospective cohort study was conducted, using data from the Swedish Trauma Registry (SweTrau) and the Karolinska University Hospital Trauma Care Quality Database (KUH TCQD). Grouping was performed adhering to cohort definitions in a complete case analysis using the programming software R. Data handling and statistical analyses were initially done using a simulated set of data to minimize bias. Semiannual and cumulative incidence of OFI was measured within cohorts and specific problem areas were identified. A trend analysis was then conducted by fitting the incidence data into a linear model with a time series component. All stages of exclusion were documented in a flowchart. 

## Setting
KUH trauma centre in Stockholm, Sweden is an American College of Surgeons trauma level-1 centre, which manages 1300 trauma patients each year. Trauma patients are triaged in a pre-hospital setting as a priority one or two by assessing vital physiological parameters, anatomical criteria, and mechanism of injury. The pre-hospital system includes a helicopter emergency medical service and three physician staffed ambulances. The in-hospital system includes a multidisciplinary trauma team comprised of a surgeon, an anesthesiologist, an orthopedic surgeon, a radiologist, a surgical nurse, an assistant surgical nurse, a nurse anesthetist, an emergency medicine nurse, an emergency medicine assistant nurse and a radiology nurse. Consultations with associated specialties are available around the clock. The team has immediate access to radiology, surgery, and intensive care.

All patients admitted to KUH with trauma team activation, as well as patients admitted without trauma team activation, but retrospectively found to have a new injury severity score (NISS) of greater than 15 are included in the Swedish national trauma registry (SweTrau). Excluded are patients who trigger trauma team activation despite not having suffered a traumatic injury and patients whose solitary injury is chronic subdural hematoma. KUH organizes monthly multidisciplinary trauma mortality and morbidity review board conferences, selecting patients from SweTrau using audit filters and extensive nursing review (see figure \@ref(fig:swetrau-flowchart)). The audit filters used at KUH are: systolic blood pressure less than 90; Glasgow coma scale (GCS) less than 9 and not intubated; injury severity score (ISS) greater than 15 and not admitted to the intensive care unit; time to acute intervention greater than 60 minutes; time to computed tomography greater than 30 minutes; and death within 30 days following trauma. The review board is comprised of representatives from all disciplines commonly involved in trauma care - surgery, vascular surgery, neurosurgery, orthopedics, anesthesia and intensive care, nursing, and radiology. Their purpose is to reach a consensus regarding the presence of OFI and implement appropriate corrective actions. The nature of that which can be improved is then registered under the variable name "problem area" in the Karolinska University Hospital's Trauma Care Quality Database (KUH TCQD).

*Fix flowchart*

```{r swetrau-flowchart, fig.cap="\\textbf{SweTrau to OFI.} \\emph{SweTrau: Swedish Trauma Registry, OFI: opportunities for improvement, KUH TCQD: Karolinska University Hospital's trauma care quality database}", out.width="100%", fig.align="center", echo=FALSE, message=FALSE, warning=FALSE}
knitr::include_graphics("swetrau_flowchart.pdf")
```


## Participants

### Study population
All adult trauma patients (defined as 15 years or older) in the KUH TCQD, with complete OFI data and a hospital admission date between 2017 and 2022 are included. 

### Cohorts
Grouping was conducted pertaining to directives from the American College of Surgeons Trauma Quality Improvement Program, using the Abbreviated Injury Scale (AIS) grading system, which forms a number of seven digits indicating (i) region of injury, (ii) type of anatomical structure, (iii) specific anatomical structure, (iv) level of injury and (v) severity of injury[@TQIP; @AIS]. Patients were grouped by principal mechanism of injury (blunt, penetrating), post-injury condition (shock, severe traumatic brain injury) and age. Certain ACS TQIP cohorts are excluded as a result of local directives, limitations to the data contained in SweTrau and the time and resources dedicated to this study. Presented below are inclusion and exclusion criteria by cohort.

**Cohort inclusion and exclusion criteria**

Cohort  | Inclusion criteria  | Exclusion criteria
------------- | ------------- | ------------------
Severe blunt multisystem injuries  | Blunt injuries with an AIS severity of 3 or greater in at least 2 of the following body regions: head, face, neck, thorax, abdomen, spine, upper, or lower extremity
Severe penetrating injuries | Penetrating truncal injury with an AIS severity of 3 or greater in the regions of the neck, chest or abdomen
Severe TBI    | Head injury with an AIS severity of 3 or greater and an ED GCS of less than 9  | Injuries in separate AIS body region with an AIS severity of 3 or greater
Shock       | ED systolic blood pressure less than 90 mm Hg
Geriatric    | Aged 65 years or greater
*AIS: Abbreviated Injury Scale, TBI: traumatic brain injury, ED: emergency department, GCS: Glasgow coma scale, mm Hg: millimeter of mercury*

## Variables
Initial cohort data is presented in a descriptive table (Table 2). Continuous variables are presented as mean, median and interquartile range. Categorical variables are presented as percentages.

### Outcome variable
The categorical variable OFI was used as outcome measure, derived from the "problem area" variable of the KUH TCQD by way of dichotomization. It was coded "true" for all patient cases with a positive problem area and "false" for all patients where none applied. All patients not included at a mortality and morbidity conference was systematically coded as "false".

## Statistical methods
Data handling and statistical analyses was conducted in the statistical programming software R. Data from SweTrau and KUH TCQD were extracted, matched by patient id and merged. Non-essential columns of variables were removed. Non-informational values were systematically changed to informational ones or removed as per instruction in the SweTrau Manual[@SweTrau]. Patients were grouped and excluded according to the cohort definitions, inclusion- and exclusion criteria listed above. Once grouping and exclusion was done to satisfaction, the semiannual and cumulative incidence of OFI was calculated for each cohort and for the study population in its entirety. A linear regression model with a time series component was then applied to the incidence data to estimate temporal incidence trends. Statistical significance was defined as P<0,05 with a 95% confidence interval.

### Bias
The method and algorithm for data analysis were developed on a step-by-step basis using simulated data. It was rigorously tested throughout its development process, until the results using the simulated data set was satisfactory. The algorithm was then reviewed by a trained programmer and statistician. Following approval, the algorithm was not changed, and the data as a result not skewed by the bias of the developer. Selection bias, caused by the inclusion criteria for the KUH TCQD and SweTrau, is possible.

### Ethical review numbers: 
2021-02541, 2021-03531

# Results
## Participants 
Over the pre-specified study period, `r nrow(datasets$problem)` patients were included in the the KUH TCQD. 5951 patients were excluded as the selection process and the constitution of the review board were different prior to 2017. `r nrow(fewer_variables)` (`r round(nrow(fewer_variables)/nrow(datasets$problem)*100, digits=1)`%) patients were aged 15 or greater and had sufficient data regarding OFI (see figure \@ref(fig:exclusion-flowchart)). The blunt multisystem cohort was comprised of `r nrow(blunt_multisystem_cohort)` patients; penetrating of `r nrow(penetrating_cohort)` patients; severe TBI of `r nrow(severe_tbi_cohort)` patients; shock of `r  nrow(shock_cohort)` patients and geriatric of `r nrow(geriatric_cohort)` patients. Five categories of data were necessary for grouping: age, emergency department gcs, emergency department systolic blood pressure, AIS score and dominant injury type (blunt or penetrating). 932 patients lacked data about age, `r Exclusion_table$Missing[3]` patients lacked data about emergency department gcs and `r Exclusion_table$Missing[4]` patients lacked data about emergency department blood pressure. No patients lacked data about dominant injury type or AIS score.

```{r exclusion-flowchart, echo=FALSE, fig.cap="\\textbf{Exclusion flowchart.} Excluded are all patients patients treated prior to 2017, as they systematically lack data about OFI. \\emph{Abbreviations: TBI: traumatic brain injury, ED GCS: emergency department Glasgow coma scale, ED SBP: emergency department systolic blood pressure.}", out.width="100%", fig.align="center"}
knitr::include_graphics("exclusion_flowchart.pdf")
```

 
## Descriptive data
Table \@ref(tab:descriptive-table) presents patient demographics in the trauma cohorts. The `r colnames(cum_inc)[apply(cum_inc,1,which.max)]` cohort had the highest percentage of OFI with `r round(max(cum_inc), digits=1)`% and the`r colnames(cum_inc)[apply(cum_inc,1,which.min)]` cohort the lowest with `r round(min(cum_inc), digits=1)`%. The severe TBI cohort had the highest 30-day-mortality with `r round(max_percent_dead, digits=1)`%, followed by the shock cohort with `r round(second_max_percent_dead, digits=1)`%. The study population is male-dominated with `r round(percent_male, digits=1)`% men. The two cohorts with the highest average NISS was blunt multisystem (35,3) and severe TBI (34,3).

```{r descriptive-table, echo=FALSE, warning=FALSE, message=FALSE, include=T}
options(kableExtra.auto_format = FALSE)
library(kableExtra)
pt_demographics <- table1(~ OFI + pt_age_yrs + Gender + ed_gcs_sum  + ed_sbp_value + NISS + res_survival | Cohort, data=merged_cohorts, caption="\\textbf{Cohort demographics}", overall = FALSE)

t1kable(pt_demographics) %>% 
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "center") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "scale_down")
```


*Abbreviations: SD: standard deviation, ED SBP: emergency department systolic blood pressure, ED GCS: emergency department Glasgow coma scale sum, NISS: new injury severity score, Survival: survival status 30 days post emergency department admission.*



## Incidence and problem areas
In the study population, the overall semiannual incidence of OFI ranged from  `r round(min(incidence.data$incidence_all), digits=2)`% to   `r round(max(incidence.data$incidence_all), digits=2)`% (see figure \@ref(fig:incidence-graph)). The highest recorded total semiannual incidence was `r round(max(incidence), digits=2)`% in the severe TBI cohort. During the second half of 2017 and the first half of 2018, total overall semiannual incidence is down. The cumulative incidence rate varied across cohorts, as well as temporally within cohorts (see figure \@ref(fig:cumulative-incidence-graph)). The cohort with the largest cumulative incidence was `r colnames(cum_inc)[apply(cum_inc,1,which.max)]` (`r round(max(cum_inc), digits=2)`%) and the cohort with the lowest was penetrating (`r round(min(cum_inc), digits=2)`%). The cumulative incidence in the overall trauma population was `r round(max(cum_inc$cum_inc_all), digits=2)`%. In the overall trauma population, the four most common problem areas was: resource management (19,8% of total OFI), emergency department triage (16,9%), time to surgery (15%) and injury identification (14,7%), see figure \@ref(fig:problem-area-barplot). 

```{r incidence-graph, fig.cap="\\textbf{Semiannual incidence of OFI.} Percentage of cases reviewed with OFI, measured with a six month interval (2017-2021). \\emph{Abbreviations: OFI: opportunities for improvement, TBI: traumatic brain injury.}", latex_options = "HOLD_position", echo=FALSE, warning=FALSE, out.width="85%", fig.align="center"}
library(ggplot2)
incidence_plot
```



```{r cumulative-incidence-graph, fig.cap="\\textbf{Cumulative incidence of OFI.} Cumulative percentage of total cohort participants with OFI (2017-2021). \\emph{Abbreviations: OFI: opportunities for improvement, TBI: traumatic brain injury.}", latex_options = "HOLD_position", echo=FALSE, warning=FALSE, out.width="85%", fig.align="center"}

library(ggplot2)
#cum_incidence_plot 

```


```{r problem-area-barplot, fig.cap="\\textbf{Identification of specific problem areas.} Percentage of total OFI in the overall trauma population attributable to specific problem areas.", echo=FALSE, warning=FALSE, message=FALSE, out.width="85%"}
library(ggplot2)
library(ggthemes)
problem_area_barplot
```


## Trends
Table \@ref(tab:trend-table) presents the outcome of a fitted linear model with a time series component. All cohorts had a negative incidence trend estimate. With statistical significance defined as p<0,05, no trends were statistically significant. The steepest trend estimate was that of Severe TBI with -0.017 (CI y-y, p=0,089). Closest to having a statistically significant trend was the shock cohort with p=0,0517.


```{r trend-table, echo=FALSE, warning=FALSE, message = FALSE, include=T}
options(kableExtra.auto_format = FALSE)
library(kableExtra)

incidence_trend_table %>% 
  kbl(caption = "\\textbf{Temporal incidence trends.} The trend estimate represents the linear models expected decline in OFI incidence every 6 months.", col.names = c("Cohort","Estimate", "P value")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "hold_position", position = "center")
```

*Abbreviations: TBI: traumatic brain injury, CI: confidence interval.*

# Discussion
# Key results
The principal aim of this study was to measure the semiannual and cumulative incidence of OFI in the trauma cohorts blunt multisystem, penetrating, severe TBI, shock and geriatric at KUH trauma centre to obtain rough estimates of care quality throughout the trauma population, independent of mortality or morbidity rates. There was sizable variance in cumulative incidence of OFI across the trauma cohorts. The cumulative incidence of OFI in the blunt multisystem cohort (17,7%), stands in stark contrast to that of the penetrating cohort (6%) or the general trauma population (5,8%). There were large shifts in amplitude in semiannual incidence of OFI. The secondary aims were to identify problem areas and estimate temporal incidence trends. The four most common problem areas in the overall cohort pertained to resource management, emergency department triage, time to surgery and injury identification. The general trauma population and all five cohorts had negative temporal incidence trend estimates, suggesting of an overall downtrend. No trend were statistically significant.

# Interpretation
The considerable divergence in cumulative incidence of OFI between cohorts is suggestive of care inequality across the traumatic spectrum of disease and warrants an explanation. The relative risk of experiencing OFI is 3.05 for the blunt multisystem cohort compared to the general trauma population and 2.95 compared to the penetrating cohort. Intuitively, one might ascribe the divergence in cumulative incidence of OFI to the difference in difficulty pertaining to diagnosing and management. In treating blunt multisystem trauma: deciphering patient presentation may be harder; the probability of missing injuries greater; and overall management generally more complex than e.g. penetrating trauma, which tend to leave little for the imagination. 

OFI is however defined as care disharmonious with best practice guidelines, with an implicit assumption that it is possible to follow said guidelines in every case to perfection. Granting that physicians sometimes must resort to professional judgement and that a significant portion of OFI recorded is attributable to hospital level factors, straying from guidelines in as much as 17,7 percent of patient cases suggests that KUH has some way to go in terms of quality improvement for patient with blunt trauma. Few results are unambiguous and these are no exception: in cumulative incidence of OFI, there is no single outlier, but rather a continuum and and potential future initiatives should reflect that and be taken proportionally. Quality improvement should also strike a balance between targeting trauma cohorts with a high cumulative incidence of OFI and trauma cohorts where care disharmonious to best practice guidelines pose the greatest risk for serious disability or death.

A study by Ghorbani et al set out to (i) estimate rates of preventable errors in care and preventable deaths and (ii) explore the use of two risk scores (TRISS, NORMIT) for predicting preventable deaths at KUH between 2012 and 2016 [28]. Their estimate for preventable errors, which can be used synonymously as OFI, is 20%. The greatest methodological difference between the studies lies in their choice of study population: theirs is comprised solely of patients deceased within 30 days following trauma. A considerably higher incidence compared to that of the general trauma population in our study (5,8%) is therefore to be expected: patients deceased due to trauma were typically more severely injured and in need of faster administration of more complex management. Identical, or close to identical results would have been surprising, a divergence of results is not.

For these results to be practically applicable at KUH trauma centre or any other institution, the isolated fact that errors exist is insufficient. To properly guide quality improvement work, it is imperative to learn what errors are made, which errors are most common and where the errors occur. In the study by Ghorbani et al, the four most common problem areas in the deceased trauma population was: inappropriate treatment (30,3%), delay to computer tomography (13.4%), procedural errors (11.9%) and delay to surgical intervention (10.4%). Our study found the most common reasons for erroneous care at KUH trauma centre in the overall trauma population to be improper resource management, emergency department mistriage, prolonged wait to necessary surgical intervention and a failure on the part of diagnosticians to identify every injury. Problem areas identified in both studies should provide the primary targets for future corrective interventions. 

The trend analysis predicts negative trends for all cohorts and for the overall study population as well. Due to large swings in amplitude and few points of measurement, no statistically significant trend could be determined. The trends estimates are small, with confidence intervals spanning both positive and negative values and although they are suggestive of downtrends, the direction (positive or negative) of the trend cannot be accurately established. A statistically significant negative trend in incidence of OFI could go some distance towards validating the effectiveness of trauma quality improvement at KUH through multidisciplinary mortality and morbidity conferences.

# Generalizability
The study results are directly applicable to the trauma population at KUH trauma centre. The findings should also be valuable for other Scandinavian level-I trauma centres, as they are similar in many aspects, and care for populations with similar demographic characteristics and burden of disease as those cared for at KUH trauma centre. There are a multitude of differences however, one being the use of different audit filters to select patients for review, wherefore the study ought to be replicated at another institution prior to drawing strong conclusions. The problem areas here identified may also be hospital specific, although one might expect some congruence in terms of the distribution in cumulative incidence of OFI across trauma cohorts in trauma centres across Scandinavia. The external validity pertaining to international trauma centers is likely limited.

# Strenghts and limitations
The study is population based and handles cross-referenced patient data from two large Scandinavian databases. It has a considerable population size and outcome data obtained from an extensive quality review process involving experts from each specialty involved in trauma care. As the study population and the KUH trauma population are the same, selection bias for the study overall is limited. Potential bias in data handling, grouping and analyses is  limited as well, as the associated  methods were developed using artificial data and not changed post hoc. 

There are several limitations to this study. There was considerable cohorts overlaps, and statistical analyses could as a result not be conducted across cohorts. The study is therefore mainly descriptive, with an impaired ability to draw strong conclusions regarding group differences. The method for patient selection to multidisciplinary mortality and morbidity review board meetings relies on audit filters. There is at present no consensus in the trauma literature as to which audit filters are effective: at KUH they are chosen, not by careful scientific scrutiny, but by consensus of an expert trauma committee. Consequently, there is a probability of selection bias as the choice of audit filters influences which patients are discussed. The high variance within cohorts in temporal incidence of OFI, limits the frequency of measurements and consequently weakens the power of the incidence trend analysis as a result. A longer study period would allow for a greater number of participants and a greater number of measurements, which in turn should garner more significant results.

The assignment of OFI is dependent on the review process and temporal incidence of OFI can therefore be affected by factors that impact the frequency of review, e.g. a move to new premises. OFI in care provided is more likely to be found in patients with outcomes severe enough to draw attention or trigger audit filters, errors in care with less severe outcomes are likely to be overlooked. As such, it cannot be claimed that OFI is a true measure for quality of care, but rather a measure for the number of severely injured patients, whom have errors in care and severe outcomes. As the average injury severity varies across cohorts, that introduces another source of bias: cohorts with a higher average injury severity should have a higher incidence of OFI. It can be argued, however, that it is for severe patient cases with severe outcomes, that the measure exerts its principal relevance, and that it does not matter much if errors in less severe cases are tossed aside: those are not the errors that matter.

# Future Studies
Future studies should seek to validate or disqualify the audit filters used at KUH trauma centre. The value of audit filters is as a predictor for OFI. A study with a large multiple logistic regression analysis to establish factors associated, and independently associated with OFI would therefore be of great value. To improve and solidify audit filters is to further automate and streamline patient selection for quality improvement work, which in turn reduces resources and efforts invested and ensures a well-functioning review process. Moreover, future studies should seek to estimate the incidence of OFI within different parts of the trauma population at KUH and other level one trauma centres. They should have a longer study period with a greater number of participants, a greater number of cohorts and include variables such as sex and age in the analyses. Lastly, they should seek to stratify the in-group incidence of OFI into the proportion of their respective problem areas to further guide future quality improvement work.

#Funding

#Contributions


