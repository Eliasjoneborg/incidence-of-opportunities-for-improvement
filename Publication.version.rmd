---
title: "Incidence of Opportunities for Improvement"
subtitle: "a retrospective cohort study in a Scandinavian level-I trauma centre"
output:
  bookdown::pdf_document2:
    toc: false
bibliography: citations.bib
link-citations: yes
csl: bmcemerg.csl
always_allow_html: true
header-includes:
  \usepackage{float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE }
#Necessary packages

library(rofi)

library(dplyr)
library(plyr)
library(incidence)
library(scales)
library(ggplot2)
library(reshape2)
library(ggthemes)
library(DiagrammeR)
library(table1)
library(jtools)
library(ggstance)
library(lubridate)
library(grid)
library(glue)
library(gtsummary)
library(flextable)


library("keyring")
library("DBI")
library("RMariaDB")
library("readr")
library(dotenv)
library(devtools)

conn <- DBI::dbConnect(drv = RMariaDB::MariaDB(),
                       user = "eliasj",
                      password = Sys.getenv("DB_PASSWORD"),
                      db = "opportunities_for_improvement")

dataset.names <- setNames(nm = c("swetrau", "fmp", "atgarder", "problem", "kvalgranskning2014.2017"))


datasets <- lapply(dataset.names, function(dataset.name) dbReadTable(conn = conn, name = dataset.name))

attach(datasets)

swetrau$arrival <- as.POSIXct(strptime(swetrau$DateTime_ArrivalAtHospital, format = "%Y-%m-%d %H:%M"))
fmp$arrival <- as.POSIXct(strptime(fmp$Ankomst_te, format = "%Y%m%d %H:%M"))
problem$arrival <- as.POSIXct(strptime(problem$Ankomst_te, format = "%Y%m%d %H:%M"))
swetrau$id <- paste(swetrau$arrival, swetrau$PersonIdentity, swetrau$TempIdentity)
fmp$id <- paste(fmp$arrival, fmp$Personnummer, fmp$Reservnummer)
problem$id <- paste(problem$arrival, problem$Personnummer, problem$Reservnummer)

## Combine datasets
combined.datasets <- merge(fmp, problem, by = "id", all.x = TRUE)
combined.datasets <- merge(combined.datasets, swetrau, by = "id", all.x = TRUE)
detach(datasets)
all_patients <-combined.datasets

combined.datasets <- filter(combined.datasets, as.Date(strptime(combined.datasets$Ankomst_te.x, format = "%Y%m%d %H:%M")) >="2017-01-01")

### Jonatans kod för flowchart:
clean_audit_filters <- function(data) {
  audit.filter <- c("VK_hlr_thorak","VK_sap_less90","VK_leverskada",
                    "VK_gcs_less9_ej_intubTE","VK_mjaltskada","VK_mer_30min_DT",
                    "VK_mass_transf","VK_mer_60min_interv","VK_iss_15_ej_iva",
                    "VK_ej_trombrof_TBI_72h","VK_iss_15_ej_TE","VK_avslutad","VK_annat")
  audit.filter2 <- c("VK_hlr_thorak","VK_sap_less90","VK_leverskada",
                     "VK_gcs_less9_ej_intubTE","VK_mjaltskada","VK_mer_30min_DT",
                     "VK_mass_transf","VK_mer_60min_interv","VK_iss_15_ej_iva",
                     "VK_ej_trombrof_TBI_72h","VK_iss_15_ej_TE","VK_annat")
  data[,audit.filter][data[,audit.filter] == "Ja"|
                        data[,audit.filter] == "ja"] <- "Yes"
  data[,audit.filter][data[,audit.filter] == "Nej"|
                        data[,audit.filter] == "nej" |
                        data[,audit.filter] == "nj\r\nNej" |
                        data[,audit.filter] == "nj"] <- "No"
  ##### Is nn = NA or No???
  data[,audit.filter][data[,audit.filter] == "nn"] <- NA
  ### Create reference vector to check for false inputs in the audit filters.
  Levels.audit.filters <- unique(as.vector(as.matrix(data[,audit.filter])))
  Levels.audit.filters <- Levels.audit.filters[!is.na(Levels.audit.filters)]
  #####
  ##.   SIC (!!!) The safety check is not compatible with a bootsrap, replications probably lack one of the original values.
  ######
  #original.levels.audit.filters <- sort(c("Yes", NA, "No"))
  #if (!identical(Levels.audit.filters, original.levels.audit.filters))
  #  stop ("Levels in Audit filters have changed")
  #########
  #  Convert NA:s in VK rows to No if VK_avslutad = Yes (To be able to calc false neg)
  #########
  data[, audit.filter2] <- lapply(data[, audit.filter2], function(column) {
    column[is.na(column) & data$VK_avslutad == "Yes"] <- "Yes"
    return (column)
  })
  return(data)
}

#combined.datasets <- dplyr::rename(combined.datasets, "Fr1-14" = Fr1.14)

combined.datasets$OFI <- create_ofi(combined.datasets) 
swetrau_problem_merged <- combined.datasets

swetrau_problem_merged$OFI <- with(swetrau_problem_merged, ifelse(is.na(OFI) | OFI == "No", "No", "Yes")) 
known_problem_area <-swetrau_problem_merged[!is.na(swetrau_problem_merged$OFI),]
#remove unknown problem area

dataset.clean.af <- clean_audit_filters(combined.datasets)

age_over_14 <- filter(known_problem_area, pt_age_yrs>14)

fewer_variables<-age_over_14 %>% select(id, inj_dominant, Problemomrade_.FMP, res_survival, pt_age_yrs, Gender, OFI, NISS, ed_gcs_sum, pre_intub_type, pre_sbp_value, pre_sbp_rtscat, ed_sbp_value, ed_sbp_rtscat, Ankomst_te.x, starts_with("AISCode"))
#removing unnecessary variables


## Changing 999 to NA for grouping into cohorts

fewer_variables$ed_sbp_value[fewer_variables$ed_sbp_value == 999] = NA
fewer_variables$ed_sbp_rtscat[fewer_variables$ed_sbp_rtscat == 999] = NA
fewer_variables$ed_gcs_sum[fewer_variables$ed_gcs_sum == 999] = NA
fewer_variables$ed_gcs_sum[fewer_variables$ed_gcs_sum == 99] = NA
fewer_variables$inj_dominant[fewer_variables$inj_dominant == 999] = NA

fewer_variables$Gender[fewer_variables$Gender == "M"] = "Male"
fewer_variables$Gender[fewer_variables$Gender == "K"] = "Female"


### COHORT GROUPING ###

## The functions below expect a row of AIS codes as input

#BLUNT MULTISYSTEM
is_serious <- function(code) {
  severity <- substr(as.character(code), 8, 8)
  as.numeric(severity) >= 3  
}
#if severity level is 3 or higher, the injury is considered serious

number_of_regions <- function(code) {
  region <- substr(as.character(code), 1, 1)
  length(unique(region))
}
#identifying number of regions

has_more_than_one_serious_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  number_of_regions(code[serious_injury]) >= 2
}

## combining them
blunt.multisystem <- apply(fewer_variables[1:100, ], 1, function(row) {
    code <- row[grep("AISCode", names(row))]
    row
})

fewer_variables$blunt_multisystem <- NA
#creating column blunt_multisystem

known_dominant_injury <-fewer_variables[!is.na(fewer_variables$inj_dominant), ] 
#removing not known in inj_dominant

for (i in 1:nrow(known_dominant_injury)) {
  v = 0+i
  if (has_more_than_one_serious_injury(known_dominant_injury[v,grepl( "AISCode" , names(known_dominant_injury))]) == TRUE && known_dominant_injury[v,"inj_dominant"] == 1) {
    known_dominant_injury[v,"blunt_multisystem"] <- TRUE
  } else {
    known_dominant_injury[v,"blunt_multisystem"] <- FALSE
  }
}
#blunt multisystem <- TRUE/FALSE 

## The above for loop could be replaced with the more R:ish apply function below, which is substantially faster (at least on my low performing machine)

known_dominant_injury$blunt_multisystem <- apply(known_dominant_injury, 1, function(row) {
    code <- row[grep("AISCode", names(row))] 
    has_more_than_one_serious_injury(code) && row["inj_dominant"] == "1"
})

#SHOCK
bp_is_na <- with(fewer_variables, is.na(ed_sbp_rtscat) & is.na(ed_sbp_value))    
known_blood_pressure <- fewer_variables[!bp_is_na,]  
#removing rows with na in both sbp value and rts
     
known_blood_pressure$ed_sbp_rtscat[is.na(known_blood_pressure$ed_sbp_rtscat)]<-10
known_blood_pressure$ed_sbp_value[is.na(known_blood_pressure$ed_sbp_value)]<-999
#an ineffective way to ensure I don't get na:s in "ed_sbp_below_90" column below

known_blood_pressure$ed_sbp_below_90 <- with(known_blood_pressure, ifelse(ed_sbp_value>=0 & known_blood_pressure$ed_sbp_value<=90, TRUE, FALSE))
known_blood_pressure$shock <- with(known_blood_pressure, ifelse(ed_sbp_below_90 == TRUE | ed_sbp_rtscat <= 3, TRUE, FALSE))
#creating column for bp<90 with TRUE/FALSE

known_blood_pressure$ed_sbp_value[(known_blood_pressure$ed_sbp_value == 999 )]<-NA

#GERIATRIC
known_age <- fewer_variables
known_age$geriatric <- with(fewer_variables, ifelse(pt_age_yrs>65, TRUE, FALSE))
#creating column in new df with TRUE/FALSE

#PENETRATING
neck_chest_abdomen_region <- function(code) {
  code <- code[!is.na(code)]
  region <- substr(as.character(code), 1, 1)  
  is.element(region,3:5)
}
#generates TRUE/FALSE

serious_neck_chest_abdomen_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  sum(neck_chest_abdomen_region(code[serious_injury]) == TRUE )
}
#generates numerical value

known_dominant_injury_pen <-fewer_variables[!is.na(fewer_variables$inj_dominant), ] 
known_dominant_injury_pen$penetrating <- NA
#removing na in dominant injury, new df

for (i in 1:nrow(known_dominant_injury_pen)) {
  v = 0+i
  if(serious_neck_chest_abdomen_injury(known_dominant_injury_pen[v,grepl( "AISCode" , names(known_dominant_injury_pen))]) >= 1 && known_dominant_injury_pen[v, "inj_dominant"] == 2) {
    known_dominant_injury_pen[v,"penetrating"] <- TRUE
  } else {
    known_dominant_injury_pen[v,"penetrating"] <- FALSE
  }
}
#penetrating <- TRUE/FALSE


#ISOLATED SEVERE TBI
head_region <- function(code) {
  code <- code[!is.na(code)]
  region <- substr(as.character(code), 1, 1)
  is.element(region, 1)
}

#returns true if body region == 1
is_serious <- function(code) {
  severity <- substr(as.character(code), 8, 8)
  as.numeric(severity) >= 3  
}

has_a_serious_head_injury <- function(code) {
    code <- code[!is.na(code)]
    serious_injury <- is_serious(code)
 head_region(code[serious_injury]) == TRUE 
}

#acts on vectors in "serious_injury", chooses those which have region == 1

only_one_region <- function(code){
  number_of_regions(code) == 1
}

#generates TRUE/FALSE

only_one_serious_injury_region <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  only_one_region(code[serious_injury])
}
#generates TRUE/FALSE

gcs_and_intub_is_na <- with(fewer_variables, is.na(ed_gcs_sum) & is.na(pre_intub_type))    
known_gcs_or_intub_type <- fewer_variables[!gcs_and_intub_is_na,]  
#remove row if na in both prehospital intub type and gcs

known_gcs_or_intub_type$gcs_below_9 <- NA

known_gcs_or_intub_type$gcs_below_9 <- with(known_gcs_or_intub_type, ifelse(ed_gcs_sum<=8 | pre_intub_type==1, TRUE, FALSE))
known_gcs_or_intub_type$gcs_below_9 <- with(known_gcs_or_intub_type, ifelse(is.na(gcs_below_9) | isFALSE(gcs_below_9), FALSE, TRUE))

#makes new variable containing those with a GCS <9 and those intubated in a prehospital setting. Converts na to false

known_gcs_or_intub_type$severe_tbi <- NA

for (i in 1:nrow(known_gcs_or_intub_type)) {
  v = 0+i
if (has_a_serious_head_injury(known_gcs_or_intub_type[v, grepl("AISCode", names(known_gcs_or_intub_type))]) == TRUE && only_one_serious_injury_region(known_gcs_or_intub_type[v, grepl("AISCode", names(known_gcs_or_intub_type))]) == TRUE && known_gcs_or_intub_type[v, "gcs_below_9"] == TRUE) {
    known_gcs_or_intub_type[v,"severe_tbi"] <- TRUE
  } else {
    known_gcs_or_intub_type[v,"severe_tbi"] <- FALSE
  }
}



### NEW COHORTS

### SEVERE TBI

has_a_serious_head_injury_new <- function(code) {
     code <- code[!is.na(code)]
     serious_injury <- is_serious(code)
  sum(head_region(code[serious_injury]) == TRUE )
 }
 
for (i in 1:nrow(known_gcs_or_intub_type)) {v = 0+i
if (has_a_serious_head_injury_new(known_gcs_or_intub_type[v, grepl("AISCode", names(known_gcs_or_intub_type))]) >=1 && known_gcs_or_intub_type[v, "gcs_below_9"] == TRUE) {
     known_gcs_or_intub_type[v,"not_isolated_tbi"] <- TRUE
   } else {
     known_gcs_or_intub_type[v,"not_isolated_tbi"] <- FALSE
   }
}

### 154 instead of 96 which was what isolated TBI had

### NEW DF
blunt_multisystem_cohort <- filter(known_dominant_injury, blunt_multisystem == "TRUE")
shock_cohort <- filter(known_blood_pressure, shock == "TRUE")
penetrating_cohort <- filter(known_dominant_injury_pen, penetrating == "TRUE")
geriatric_cohort <- filter(known_age, geriatric == "TRUE")
isolated_severe_tbi_cohort <-filter(known_gcs_or_intub_type, severe_tbi == "TRUE")
severe_tbi_cohort <- filter(known_gcs_or_intub_type, not_isolated_tbi== "TRUE")
overall <- fewer_variables


### BLUNT MULTISYSTEM AND SEVERE TBI

BM_and_TBI_cohort <- merge(blunt_multisystem_cohort, severe_tbi_cohort[, c("id", setdiff(colnames(severe_tbi_cohort),colnames(blunt_multisystem_cohort)))], by="id")

### BLUNT MULTISYSTEM NO SEVERE TBI
BM_no_TBI_cohort <- blunt_multisystem_cohort[!blunt_multisystem_cohort$id %in% severe_tbi_cohort$id, ]

### FOUR RELEVANT COHORTS

# 1: BLUNT MULTISYSTEM NO TBI (n=407)
BM_no_TBI_cohort
# 2: BLUNT MULTISYSTEM AND TBI (n=56)
BM_and_TBI_cohort
# 3: ISOLATED SEVERE TBI (n=96)
isolated_severe_tbi_cohort
# 4: PENETRATING COHORT (n=183)
penetrating_cohort

#### MERGING 

  #merging cohorts
 four_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(isolated_severe_tbi_cohort, BM_and_TBI_cohort, BM_no_TBI_cohort, penetrating_cohort, isolated_severe_tbi_cohort))

 #removing overlaps
 remaining_cohort <- overall[!overall$id %in% four_cohorts$id, ]



#creating cohort df:s

 #creating common variable "cohort"

 geriatric_cohort$Cohort <- "Geriatric"
 penetrating_cohort$Cohort <- "PT"
 isolated_severe_tbi_cohort$Cohort <- "TBI"
 severe_tbi_cohort$Cohort <- "Severe TBI"
 shock_cohort$Cohort <- "Shock"
 blunt_multisystem_cohort$Cohort <- "Blunt multisystem"
 BM_and_TBI_cohort$Cohort <- "BMTBI"
 BM_no_TBI_cohort$Cohort <- "BM"
 overall$Cohort <- "Overall"
 remaining_cohort$Cohort <- "Remaining"

  relevant_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(isolated_severe_tbi_cohort, BM_and_TBI_cohort, BM_no_TBI_cohort, penetrating_cohort, isolated_severe_tbi_cohort, remaining_cohort, overall))




#### PLOTTING
  
  ## FLOWCHARTS                  
            
  
  
                  
  #SweTrau to review     
  
  
  ### JONATANS FLOWCHART
## Data/numbers for flowchart ##
################################
df <- subset(dataset.clean.af, dataset.clean.af$tra_DodsfallsanalysGenomford == 1)
n.df <- nrow(df)
df2 <- subset(dataset.clean.af, dataset.clean.af$Fr1.14 == 2 | dataset.clean.af$Fr1.14 == 3)
#df3 <- subset(dataset.clean.af,dataset.clean.af$tra_id == 77521)
df2 <- df2[,c("VK_avslutad","tra_DodsfallsanalysGenomford","Problemomrade_.FMP","Fr1.14","tra_id","OFI","Deceased")]
### Yes and No from mortality conferance
n.df.ofi <- sum(df$OFI == "Yes", na.rm = TRUE)
n.df.no.ofi <- sum(df$OFI == "No", na.rm = TRUE)
### Patients who have gone trough dödsfall but have no consensus
df.exc <- df[is.na(df$OFI) == TRUE, ]
# qd = quality database
qd <- subset(dataset.clean.af, dataset.clean.af$VK_avslutad == "Yes")
qd<- subset(qd, is.na(qd$tra_DodsfallsanalysGenomford) == TRUE  | qd$tra_DodsfallsanalysGenomford == 2 )
n.qd <- nrow(qd)
clean.qd <- qd
audit.qd <- clean.qd[clean.qd$VK_hlr_thorak == "Yes" |
                            clean.qd$VK_sap_less90 == "Yes" |
                            clean.qd$VK_leverskada == "Yes" |
                            clean.qd$VK_gcs_less9_ej_intubTE == "Yes" |
                            clean.qd$VK_mjaltskada == "Yes" |
                            clean.qd$VK_mer_30min_DT == "Yes" |
                            clean.qd$VK_mass_transf == "Yes" |
                            clean.qd$VK_mer_60min_interv == "Yes" |
                            clean.qd$VK_iss_15_ej_iva == "Yes" |
                            clean.qd$VK_ej_trombrof_TBI_72h == "Yes"|
                          clean.qd$VK_annat == "Yes", ]
n.audit.qd <- nrow(audit.qd)
#### Patients with all filters No and VK_avslutad = YES - > Still have 2 OFI!!!??
allneg.ofi <- clean.qd[clean.qd$VK_hlr_thorak == "No" &
                            clean.qd$VK_sap_less90 == "No" &
                            clean.qd$VK_leverskada == "No" &
                            clean.qd$VK_gcs_less9_ej_intubTE == "No" &
                            clean.qd$VK_mjaltskada == "No" &
                            clean.qd$VK_mer_30min_DT == "No" &
                            clean.qd$VK_mass_transf == "No" &
                            clean.qd$VK_mer_60min_interv == "No" &
                            clean.qd$VK_iss_15_ej_iva == "No" &
                            clean.qd$VK_ej_trombrof_TBI_72h == "No" &
                            clean.qd$VK_annat == "No" &
                            clean.qd$OFI == "Yes" , ]
n.allneg.ofi <- nrow(allneg.ofi)
### Exkluden in first step
allneg.no.ofi <- clean.qd[clean.qd$VK_hlr_thorak == "No" &
                            clean.qd$VK_sap_less90 == "No" &
                            clean.qd$VK_leverskada == "No" &
                            clean.qd$VK_gcs_less9_ej_intubTE == "No" &
                            clean.qd$VK_mjaltskada == "No" &
                            clean.qd$VK_mer_30min_DT == "No" &
                            clean.qd$VK_mass_transf == "No" &
                            clean.qd$VK_mer_60min_interv == "No" &
                            clean.qd$VK_iss_15_ej_iva == "No" &
                            clean.qd$VK_ej_trombrof_TBI_72h == "No" &
                            clean.qd$VK_annat == "No" &
                              clean.qd$OFI == "No" &
                            clean.qd$VK_avslutad == "Yes" , ]
n.allneg.no.ofi <- nrow(allneg.no.ofi)
### Selected VK_Annat
n.annat <- nrow(clean.qd[clean.qd$VK_hlr_thorak == "No" &
                              clean.qd$VK_sap_less90 == "No" &
                              clean.qd$VK_leverskada == "No" &
                              clean.qd$VK_gcs_less9_ej_intubTE == "No" &
                              clean.qd$VK_mjaltskada == "No" &
                              clean.qd$VK_mer_30min_DT == "No" &
                              clean.qd$VK_mass_transf == "No" &
                              clean.qd$VK_mer_60min_interv == "No" &
                              clean.qd$VK_iss_15_ej_iva == "No" &
                              clean.qd$VK_ej_trombrof_TBI_72h == "No" &
                              clean.qd$VK_annat == "Yes" &
                              clean.qd$VK_avslutad == "Yes" , ])
### To get the two nurse cohort - First take the cohort with some VK_ and VK_avslutad. Then check which have no OFI.
nurse <- audit.qd[audit.qd$OFI == "No" & is.na(audit.qd$Problemomrade_.FMP) == TRUE, ]
## To get the Mortality group just check the cases that hade any VK and then if thay have something in problemområde
MoM <- audit.qd[is.na(audit.qd$Problemomrade_.FMP) == FALSE , ]
n.MoM <- nrow(MoM)
n.MoM.no.ofi <- sum(MoM$OFI == "No")
n.MoM.ofi <- sum(MoM$OFI == "Yes")
p.MoM.ofi <- round((n.MoM.ofi/n.qd)*100,digits=2)
n.allneg.no.ofi <- nrow(dataset.clean.af)-n.df - n.annat - n.audit.qd - 1
n.2nurse.no.ofi <- n.annat + n.audit.qd - n.MoM

### Fortsättning
 
DiagrammeR::grViz("
digraph graph2 {
graph [layout = dot, rankdir = RR, size=60]
# node definitions with substituted label text
node [width = 4, fillcolor = Biege, shape = rectangle]
swetrau [label = '@@1']
qd [label = '@@2']
audit [label = '@@3']
annat [label = '@@4']
nurse [label = '@@5']
MoM [label = '@@6']
MoMnoofi [label = '@@7', shape = plaintext, width = 0]
df [label = '@@8', shape = plaintext, width = 0]
ofi [label = '@@9']
noofi [label = '@@10']
dfofi [label = '@@11', style = invis]
dfnoofi [label = '@@12', style = invis]
nursenoofi [label = '@@13', shape = plaintext, width = 0]
allneg [label = '@@14', shape = plaintext, width = 0]
MoMofi [label = '@@15', shape = plaintext, width = 0]
allnegofi [label = '@@16', shape = plaintext, width = 0]
swetrau -> qd -> audit -> nurse -> MoM -> MoMnoofi -> noofi
qd -> annat -> nurse
MoM -> MoMofi -> ofi
swetrau -> df -> MoM
nurse -> nursenoofi -> noofi
qd -> allneg -> noofi
qd -> allnegofi -> ofi
}
[1]: paste0('Trauma Care Quality Database (n = ', nrow(dataset.clean.af), ')')
[2]: paste0('Manual review and audit filters (n = ', nrow(dataset.clean.af)-n.df, ')')
[3]: paste0('Selected via audit filters (n = ', n.audit.qd, ')')
[4]: paste0('Selected via nursing review (n = ', n.annat, ')')
[5]: paste0('Secondary review by two nurses (n = ', n.annat + n.audit.qd, ')')
[6]: paste0('Morbidity and mortality review (n = ', n.MoM + n.df, ')')
[7]: paste0('(n = ', n.MoM.no.ofi + n.df.no.ofi, ')')
[8]: paste0('Deceased (n = ', n.df, ')')
[9]: paste0('OFI(n = ', n.df.ofi + n.MoM.ofi + n.allneg.ofi, ')')
[10]: paste0('No OFI (n = ', n.df.no.ofi + n.MoM.no.ofi + n.2nurse.no.ofi + n.allneg.no.ofi,  ')')
[11]: paste0('(n = ', n.df.ofi, ')')
[12]: paste0('(n = ', n.df.no.ofi, ')')
[13]: paste0('(n = ', n.2nurse.no.ofi, ')')
[14]: paste0('(n = ', n.allneg.no.ofi, ')')
[15]: paste0('(n = ', n.MoM.ofi + n.df.ofi , ')')
[16]: paste0('(n = ', n.allneg.ofi, ')')
", height = "500") %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% rsvg::rsvg_pdf("ofi-flowchart.pdf")

 swetrau_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot]

# node definitions with substituted label text
node [fontname = Helvetica, shape = box, width = 5]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']

blank [label = '', width = 0.01, height = 0.01]

a -> g
a -> b
b -> c
b -> d
b -> i [label = 'Negative audit filters and OFI not suspected']
c -> e
d -> e
e -> i [label = 'OFI not suspected']
e -> f
f -> h
f -> i
g -> h
g -> i


}

[1]: paste0('Trauma Care Quality Database')
[2]: paste0('Manual review and audit filters')
[3]: paste0('Selected by nurse')
[4]: paste0('Selected by audit filters')
[5]: paste0('Secondary review by two nurses')
[6]: paste0('Morbidity conference')
[7]: paste0('Mortality conference')
[8]: paste0('OFI')
[9]: paste0('no OFI')
", height = "100") %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% rsvg::rsvg_pdf("swetrau_flowchart.pdf")                
  
#Stages of exclusion  
                        
   a <- c(0,1)               
   a$a <- nrow(datasets$problem) 
   a <- as.data.frame(a)
   a$b <- nrow(known_problem_area)
   a$c <- nrow(age_over_14)
   a$d <- nrow(fewer_variables)
   a$e <- nrow(BM_and_TBI_cohort)
   a$f <- nrow(BM_no_TBI_cohort)
   a$g <- nrow(isolated_severe_tbi_cohort)
   a$i <- nrow(penetrating_cohort)
   a$j <- nrow(problem) - nrow(known_problem_area)
            
  #df with nrow of relevant df:s to be used as reference in code below 
   
exclusion_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot, size=30, ranksep = 2 nodesep = 2]

node [fontname = Helvetica, shape = box, height = 2, width = 12, fontsize = 50, penwidth =6]

a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
h [label = '@@7']
i [label = '@@8']
j [label = '@@9']
blank [label ='', width = 0.01, height = 0.01]
blank2 [label ='', width = 0.01, height = 0.01]



a -> blank [arrowhead = none]
blank -> i
i -> blank2 [arrowhead = none]
blank2 -> b

blank -> h
blank2 -> j
{rank = same; blank; h;}
{rank = same; blank2; j;}


b -> c
b -> d
b -> e
b -> f



}

[1]: paste0('Trauma care quality database (n = ', a$b, ')')
[2]: paste0('Eligible for grouping stage (n = ', a$d, ')')
[3]: paste0('BM (n = ', a$f, ')')
[4]: paste0('BMTBI (n = ', a$e, ')')
[5]: paste0('TBI (n = ', a$g, ')')
[6]: paste0('PT (n = ', a$i, ')')
[7]: paste0('Missing age data (n=932)')
[8]: paste0('Complete age data (n=5216)')
[9]: paste0('Age<15 (n=2)')

", height = "500") %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% rsvg::rsvg_pdf("exclusion_flowchart.pdf")

  

#### GROUPING AND EXCLUSION TABLE
   
Cohort <- c("Isolated Severe TBI", "Blunt multisystem and severe TBI", "Blunt multisystem without severe TBI", "Penetrating truncal", "Remaining", "All")
Category <- c("Dominant injury type", "Dominant injury type", "ED GCS", "ED SBP", "Age")
Missing <- c((nrow(fewer_variables)-nrow(known_dominant_injury)),(nrow(fewer_variables)-nrow(known_dominant_injury)), (nrow(fewer_variables)-nrow(known_gcs_or_intub_type)), (nrow(fewer_variables)-nrow(known_blood_pressure)), (nrow(fewer_variables)-nrow(known_age)))
Missing_as_percent <- c( round(((nrow(fewer_variables)-nrow(known_dominant_injury))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_dominant_injury))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_gcs_or_intub_type))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_blood_pressure))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(known_age))/nrow(fewer_variables)*100), digits = 2))
   
#Exclusion_table <- data.frame(Cohort, Category, Missing, Missing_as_percent)




 

#### PATIENT DEMOGRAPHICS 

                  relevant_cohorts$res_survival <- with(relevant_cohorts, ifelse(res_survival== "1", "Dead", "Alive"))
                   relevant_cohorts$inj_dominant <- with(relevant_cohorts, ifelse(inj_dominant== "1", "Blunt", "Penetrating"))
                   relevant_cohorts$not_isolated_tbi <- with(relevant_cohorts, ifelse(not_isolated_tbi== "TRUE", "Yes", "No"))
                   relevant_cohorts$not_isolated_tbi <- with(relevant_cohorts, ifelse(is.na(not_isolated_tbi), "No", "Yes"))
                   
                  relevant_cohorts$NISS<- as.numeric(relevant_cohorts$NISS)
                  render.continuous.default(relevant_cohorts$NISS)
                  relevant_cohorts$pt_age_yrs<- as.numeric(relevant_cohorts$pt_age_yrs)
                  render.continuous.default(relevant_cohorts$pt_age_yrs)
                  relevant_cohorts$ed_gcs_sum<- as.numeric(relevant_cohorts$ed_gcs_sum)
                  render.continuous.default(relevant_cohorts$ed_gcs_sum)
  
                  label(relevant_cohorts$NISS)              <- "NISS"
                  label(relevant_cohorts$ed_sbp_value)      <- "ED SBP"
                  label(relevant_cohorts$pt_age_yrs)        <- "Age"
                  label(relevant_cohorts$ed_gcs_sum)        <- "ED GCS"
                  label(relevant_cohorts$res_survival)      <- "Survival"
                  label(relevant_cohorts$Gender)            <- "Sex"
                  label(relevant_cohorts$inj_dominant)      <- "Dominant injury type"
                  label(relevant_cohorts$OFI)               <- "OFI"
                  label(relevant_cohorts$not_isolated_tbi)  <- "S-TBI"
                  
                  units(relevant_cohorts$ed_sbp_value)   <- "mmHg"
                  units(relevant_cohorts$pt_age_yrs)    <-"years"
                  
                  relevant_cohorts$Cohort <- factor(relevant_cohorts$Cohort, levels = c( "BM", "BMTBI","TBI", "PT", "Remaining", "Overall"))
                  
              
                  pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a one way anova test
      p <- kruskal.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g), simulate.p.value = TRUE)$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
                  }
                  
                  
                  
                
                  
                  pt_demographics <- table1(~ OFI + pt_age_yrs + Gender + ed_gcs_sum  + ed_sbp_value + NISS + res_survival + inj_dominant | Cohort, data=relevant_cohorts, caption="\\textbf{Demographics.} Patients with missing ED GCS data were intubated in a pre-hospital setting.", overall = FALSE)
                  
#+ not_isolated_tbi
#Lägg till ovan om du vill inkludera svår traumatisk hjärnskada som faktor               
              
 #extra.col=list("P-value"=pvalue) 
#Lägg till ovan om du vill inkludera p-värden i den deskriptiva tabellen       

         
                    pt_demographics
               

#### INCIDENCE CALCULATIONS

   
                  
   fewer_variables$date <- as.Date(strptime(fewer_variables$Ankomst_te.x, format = "%Y%m%d %H:%M"))
#converting date               
                

### INCIDENCE (3-months)

cohorts <- list(BM_no_TBI_cohort = BM_no_TBI_cohort, BM_and_TBI_cohort = BM_and_TBI_cohort,
                 isolated_severe_tbi_cohort = isolated_severe_tbi_cohort,
                 penetrating_cohort = penetrating_cohort, remaining_cohort = remaining_cohort,
                 overall = overall)
 calculate_incidence <- function(cohort) {
     cohort$date <- as.Date(strptime(cohort$Ankomst_te.x, format = "%Y%m%d %H:%M"))
     cohort.ofi <- incidence(cohort$date, interval = "6 months", groups = cohort$OFI) %>% as.data.frame()
     cohort.ofi$incidence <- 0
     if (is.element("No", names(cohort.ofi)))
         cohort.ofi$incidence <- cohort.ofi$Yes / (cohort.ofi$Yes + cohort.ofi$No) * 100
     return (cohort.ofi)
 }
 incidence.data <- lapply(cohorts, calculate_incidence)


### CUMULATIVE INCIDENCE (year)

 calculate_percent_of_total <- function(cohort) {
     cohort$date <- as.Date(strptime(cohort$Ankomst_te.x, format = "%Y%m%d %H:%M"))
     cohort.ofi <- incidence(cohort$date, interval = "6 months", groups = cohort$OFI) %>% as.data.frame()
     cohort.ofi$per_tot <- 0
     if (is.element("No", names(cohort.ofi)))
         cohort.ofi$per_tot <- cohort.ofi$Yes / c(nrow(cohort)) * 100
     return (cohort.ofi)
 }
     
  percentage.data <- lapply(cohorts, calculate_percent_of_total)    
 
 get_cum_inc<- function(cohort){
cum_inc <- transform(cohort, cum_inc = cumsum(cohort$per_tot))
 return(cum_inc)
 }
 
cumulative.incidence.data <- lapply(percentage.data, get_cum_inc)
 




#### RENAMING VARIABLES

incidence_data <- incidence.data
incidence.data$BM_and_TBI_cohort$incidence_bm_tbi <- incidence.data$BM_and_TBI_cohort$incidence
incidence.data$BM_no_TBI_cohort$incidence_bm <- incidence.data$BM_no_TBI_cohort$incidence
incidence.data$isolated_severe_tbi_cohort$incidence_tbi <- incidence.data$isolated_severe_tbi_cohort$incidence
incidence.data$penetrating_cohort$incidence_pen <- incidence.data$penetrating_cohort$incidence
incidence.data$remaining_cohort$incidence_rem <- incidence.data$remaining_cohort$incidence
incidence.data$overall$incidence_all <- incidence.data$overall$incidence

#making unique variable name for each cohort (there surely is a way to do this more efficiently, but right now it is not my focus
cumulative.incidence_data <- incidence.data
cumulative.incidence.data$BM_and_TBI_cohort$cum_inc_bm_tbi <- cumulative.incidence.data$BM_and_TBI_cohort$cum_inc
cumulative.incidence.data$BM_no_TBI_cohort$cum_inc_bm <- cumulative.incidence.data$BM_no_TBI_cohort$cum_inc
cumulative.incidence.data$isolated_severe_tbi_cohort$cum_inc_tbi <-cumulative.incidence.data$isolated_severe_tbi_cohort$cum_inc
cumulative.incidence.data$penetrating_cohort$cum_inc_pen <- cumulative.incidence.data$penetrating_cohort$cum_inc
cumulative.incidence.data$remaining_cohort$cum_inc_rem <- cumulative.incidence.data$remaining_cohort$cum_inc
cumulative.incidence.data$overall$cum_inc_all <- cumulative.incidence.data$overall$cum_inc



#no2


cumulative.incidence.data <- bind_rows(cumulative.incidence.data, .id = NULL)
cumulative.incidence.data[is.na(cumulative.incidence.data)] = 0
cumulative.incidence.data<- ddply(cumulative.incidence.data,"dates",numcolwise(sum))
#list to df

incidence.data <- bind_rows(incidence.data, .id = NULL)
incidence.data[is.na(incidence.data)] = 0
incidence.data<- ddply(incidence.data,"dates",numcolwise(sum))
#list to df




#### PLOTTING INCIDENCE AND CUMULATIVE INCIDENCE

#Yearly incidence as %
plot_inc_year <- incidence.data %>% select(dates,incidence_bm, incidence_bm_tbi, incidence_tbi, incidence_pen, incidence_all)

plot_inc_year_long <- melt(plot_inc_year, id.vars = "dates")
#melt as to enable ggplot to work

library(gridExtra)
library(grid)
library(ggthemes)

incidence_plot <- ggplot(plot_inc_year_long,
       aes(x=dates,
           y=value,
           col = variable)) + 
  scale_color_discrete(name = "Cohort", labels = c("BM", "BMTBI", "TBI", "PT", "Overall")) +
  geom_line(size = 1.0, alpha = 1.0) +
  labs(x = "Year",
       y = "%") +
  theme_tufte() +
  theme(axis.title = element_text(), legend.title = element_blank()) 

#Right now not showing S-TBI cohort as there are missing values.


#Cumulative incidence
plot_cum_inc<-cumulative.incidence.data %>% select(dates, cum_inc_bm, cum_inc_bm_tbi, cum_inc_tbi, cum_inc_pen, cum_inc_all)

plot_cum_inc_long <- reshape2::melt(plot_cum_inc, id.vars = "dates")



cum_incidence_plot<- ggplot(plot_cum_inc_long,
       aes(x=dates,
           y=value,
           col=variable)) +
  scale_color_discrete(name = "Cohort", labels = c("BM", "BMTBI", "TBI", "PT","Overall")) +
  scale_shape_manual(name = "Cohort",
                     labels = c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock","Geriatric", "Overall"),
                     values = c(0, 1, 2, 3, 4, 5, 6)) +
  geom_line(size = 1.0, alpha = 1.0) +
  labs(x = "Year",
       y = "%") +
  theme_tufte() +
  theme(axis.title = element_text(), legend.title = element_blank())


#### INCIDENCE TRENDS

library(fable)
library(broom)
calculate_incidence_trends <- function(cohort) {
   trend <- as_tsibble(cohort) %>% model(lm = TSLM(incidence ~ trend())) %>% tidy()
     return (trend)
}

incidence.trends <- lapply(incidence_data, calculate_incidence_trends)


BM_and_TBI_incidence_trend <- incidence.trends$BM_and_TBI_cohort[c(2), ] 
BM_no_TBI_incidence_trend <- incidence.trends$BM_no_TBI_cohort[c(2), ] 
Isolated_TBI_incidence_trend <- incidence.trends$isolated_severe_tbi_cohort[c(2), ] 
Penetrating_incidence_trend <- incidence.trends$penetrating_cohort[c(2), ] 
Remaining_incidence_trend <- incidence.trends$remaining_cohort[c(2), ]
Overall_incidence_trend <- incidence.trends$overall[c(2), ] 

BM_and_TBI_incidence_trend$cohort <- "BMTBI"
BM_no_TBI_incidence_trend$cohort <-"BM"
Isolated_TBI_incidence_trend$cohort <- "TBI"
Penetrating_incidence_trend$cohort <- "PT"
Remaining_incidence_trend$cohort <- "Remaining"
Overall_incidence_trend$cohort <- "Overall"

incidence_trend_table <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(BM_and_TBI_incidence_trend, BM_no_TBI_incidence_trend, Isolated_TBI_incidence_trend, Penetrating_incidence_trend, Remaining_incidence_trend, Overall_incidence_trend))

library(dplyr)
library(readxl)

names(incidence_trend_table) <- c('Model', 'Term', 'Estimate', 'SD_error', 'Statistic', 
                       'P_value', 'Cohort')
incidence_trend_table <- incidence_trend_table[,c(7, 3, 4, 5, 6, 2, 1)]
incidence_trend_table <- incidence_trend_table[, -c(3,4,6,7)]

incidence_trend_table <- incidence_trend_table[c(4,6,1,5,3), ]
rownames(incidence_trend_table) <- c()


### MULTIPLE LOGISTIC REGRESSION
all_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(BM_and_TBI_cohort, BM_no_TBI_cohort, isolated_severe_tbi_cohort, penetrating_cohort))

all_cohorts$OFI <- as.factor(all_cohorts$OFI)
all_cohorts$Cohort <- as.factor(all_cohorts$Cohort)

log_reg <- glm(OFI ~ Cohort, all_cohorts, family = binomial)

library(dplyr)

log_reg_table <- log_reg %>%
  tbl_regression(
    exponentiate = TRUE, 
    pvalue_fun = ~style_pvalue(.x, digits = 2),
  ) %>% 
modify_footnote(c(all_stat_cols()) ~ NA) %>% 
  bold_p(t = 0.05) %>%
  bold_labels() 


#### REFERENCES FOR MARKDOWN CHUNKS

cum_inc <- select(plot_cum_inc, -dates)
cum_inc <- cum_inc %>% slice(-c(1:8))


#incidence <- select(incidence.data, incidence_bm_tbi, incidence_bm, incidence_tbi, incidence_pen)

min.col <- function(m, ...) max.col(-m, ...)


pt_demographics_flex<- t1flex(pt_demographics)

FitFlextableToPage <- function(ft, pgwidth = 6){
    ft_out <- ft %>% autofit()
      ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}


max_percent_dead <- c(nrow(filter(isolated_severe_tbi_cohort, res_survival == 1))) / c(nrow(isolated_severe_tbi_cohort)) * 100
percent_male <- c(nrow(filter(fewer_variables, Gender == "Male"))) / c(nrow(fewer_variables)) * 100

```


# Background

Trauma, defined as physical injury and the body’s associated response[@Gerdin2015], is the leading cause of death in patients aged 45 and younger[@GlobalStats]. For every trauma death, three persons are rendered permanently disabled[@Trauma], which significantly amplifies the social and economic impact of the disease as well as the importance of quality trauma care. 

Trauma care throughout large parts of the world has been subject to extensive quality improvement initiatives such as the American College of Surgeons (ACS) Trauma Quality Improvement Program (TQIP)[@TQIP], the Michigan Trauma Quality Improvement Program (MTQIP) [@MQIP] and the Australian Trauma Quality Improvement Program (Aus-TQIP)[@ANTRC]. Pivotal to these efforts are benchmarking of outcomes through trauma registries and continuous retrospective assessment of care provided through multidisciplinary morbidity and mortality review conferences[@MQIP;@TQIP; @ANTRC].

There is a lack of well performing quality indicators within trauma epidemiology[@QI]. The most commonly used indicator, trauma related preventable deaths (TRPD)[@Preventable_1], has been under considerable scrutiny due to its poor inter-rater reliability[@InterRR] and external validity[@Preventable_1]. The principal cause of the divergence is not disagreement of the inappropriateness of care, but of its relation to patient death[@InterRR]. Rates of opportunities for improvement (OFI) in care provided are considered independent of attributions of causality and constitutes a more accurate measure for care quality[@Preventable_6].

Few studies have recorded rates of OFI. Their results have differed significantly, likely due to the difference in methods and choice of study population[@Preventable_6; @HemorrhageOFI; @RwandaOFI]. At present, the poor heterogeneity between studies renders comparisons of absolute rates problematic. A greater number of studies on rates of OFI is therefore sorely needed.

Hitherto, no studies have looked at the distribution of OFI across clinically important subsets of the trauma population or how that distribution varies temporally. Unequal distributions of OFI across the traumatic spectrum of injury could spotlight negative trends that may be rectified by corrective intervention. Hence, the aim of this study is to measure and compare cumulative and semiannual incidence of OFI in care provided across subsets of the Scandinavian trauma population and predict temporal incidence trends.

# Methods
## Study design
We analysed data from the Karolinska University Hospital (KUH) Trauma Registry and the Karolinska University Hospital (KUH) Trauma Care Quality Database. We grouped patients to four non-overlapping trauma cohorts: patients with severe blunt multisystem injuries and a severe traumatic brain injury (BMTBI); patients with severe blunt multisystem injuries without a severe traumatic brain injury (BM); patients with an isolated severe traumatic brain injury (TBI) and patients with severe penetrating truncal injuries (PT). Thereafter we measured and compared semiannual and cumulative incidence of OFI, outlined the incidence rates temporally and performed a trend analysis.

## Setting
KUH trauma centre in Stockholm, Sweden is the equivalent of an American College of Surgeons trauma level-1 centre[@Granstrom] and manages approximately 1500 trauma patients each year[@TCK]. The pre-hospital system includes a helicopter emergency medical service and three physician staffed ambulances. The in-hospital system includes a multidisciplinary trauma team comprised of a surgeon, an anesthesiologist, an orthopedic surgeon, a radiologist, a surgical nurse, an assistant surgical nurse, a nurse anesthetist, an emergency medicine nurse, an emergency medicine assistant nurse and a radiology nurse. Consultations with associated specialties are available around the clock. The team has immediate access to radiology, surgery, and intensive care.

All patients admitted to KUH with trauma team activation, as well as patients admitted without trauma team activation, but retrospectively found to have a new injury severity score (NISS) of greater than 15 are included in the KUH Trauma Registry and Trauma Care Quality Database. Patients who trigger trauma team activation despite not having suffered trauma and patients whose only injury is chronic subdural hematoma are not included[@SweTrau]. KUH organizes monthly multidisciplinary morbidity and mortality review conferences, selecting patients from the KUH Trauma Registry and Trauma Care Quality Database (see Figure \@ref(fig:swetrau-flowchart)). Each record is screened by a nurse and passed through audit filters. Audit filters used at KUH are: systolic blood pressure less than 90; Glasgow coma scale (GCS) less than 9 and not intubated; injury severity score (ISS) greater than 15 and not admitted to the intensive care unit; time to acute intervention greater than 60 minutes; time to computed tomography greater than 30 minutes; and death within 30 days following trauma.

Cases flagged by audit filters or by concern from the reviewing nurse moves on to a secondary round of reviews conducted by two specialized nurses. If the secondary review fails to identify a valid reason for the audit filter trigger or if there is remaining concern, the case is escalated to a morbidity and mortality review conference. Patients deceased within 30 days following major trauma are selected for review regardless of the validity of their audit filter trigger. The review boards are comprised of representatives from all disciplines commonly involved in trauma care - surgery, vascular surgery, neurosurgery, orthopedics, anesthesia and intensive care, nursing, and radiology. Their purpose is to reach a consensus regarding the presence of OFI and implement appropriate corrective actions. For each case, the primary improvement area or lack thereof, is documented in the KUH Trauma Care Quality Database.

```{r swetrau-flowchart, fig.cap="\\textbf{From the Trauma Care Quality Database to OFI.} Outlined is the selection process for trauma morbidity and mortality review conferences at Karolinska University Hospital between 2017 and 2021. For every case a consensus about OFI is reached. \\emph{Abbreviations: OFI = opportunities for improvement}", out.width ="100%", fig.align="center", echo=FALSE, message=FALSE, warning=FALSE}
knitr::include_graphics("ofi-flowchart.pdf")
```

## Participants

### Study population
We included all adult trauma patients (defined as 15 years or older) in the KUH Trauma Care Quality Database with a hospital admission date between 2017 and 2022. 2017 was selected as the lower threshold because the review process was formalized that year. Cohort definitions were extracted from Horner et al.[@QualityBenchmarking] and then modified to reflect what we considered to be clinically important subsets of the trauma population.
 
Table: (\#tab:cohort-table) **Cohort definitions.** Severity of injury is derived from the Abbreviated Injury Scale (AIS). Injuries with an associated AIS severity score of 3 or greater are considered severe. 

**Cohort**  | **Inclusion criteria**  | **Exclusion criteria**
------------- | ------------- | ------------------
BM| Severe blunt injuries in at least 2 of the following body regions: head, face, neck, thorax, abdomen, spine, upper, or lower extremity. | Severe head injury in addition to an ED GCS of less than 9.
BMTBI | Severe blunt injuries in at least 2 of the following body regions: head, face, neck, thorax, abdomen, spine, upper, or lower extremity. At least one of the injuries must be a severe head injury. | ED GCS greater than 9.
TBI | Severe head injury and an ED GCS of less than 9. | Severe injury in separate AIS body region.
PT | Severe penetrating injury in one of the following regions: neck, chest or abdomen.

*Abbreviations: BMTBI = severe blunt multisystem injuries and a severe traumatic brain injury, BM = severe blunt multisystem injuries without a severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury, ED = emergency department, GCS = Glasgow coma scale, mm Hg = millimeter of mercury*


## Variables

### Outcome measure
We used the variable OFI, derived from the KUH Trauma Care Quality Database, as our outcome measure. OFI is defined dichotomously, with the levels “Yes" (One or more OFI identified) and “No" (No OFI identified). 

### Descriptive data
We included all grouping variables in the table of descriptive statistics (Table \@ref(tab:descriptive-table)) with the exception of AIS score. Further, we added NISS, sex and 30 day mortality. Continuous variables are presented as mean, median and minimum and maximum range. Categorical variables are presented as percentages.

## Statistical methods
We used R for data management and statistical analyses[@R]. First, we extracted data from the KUH Trauma Registry and Trauma Care Quality Database, and matched observations between databases using patient id and hospital admission date. Thereafter we assigned patients to trauma cohorts using the definitions listed above and calculated the semiannual and cumulative incidence of OFI for each cohort and for the total study sample. Further, we performed a logistic regression analysis comparing cohort belonging and OFI. Lastly, the R package Fable TSLM[@R], a linear model with a time series component, was applied to the incidence data to predict temporal incidence trends. Statistical significance was defined as P < 0,05 with a 95% confidence interval.

## Bias
We addressed potential bias in data handling, grouping and analysis by developing the associated methods on a simulated set of data. The code was rigorously tested throughout its development process and not changed following the transition to real data.

## Ethical review numbers: 
2021-02541, 2021-03531

# Results
## Participants 
Figure \@ref(fig:exclusion-flowchart) showcases the stages of exclusion. The KUH Trauma Care Quality Database contained 6148 patients, of which `r nrow(fewer_variables)`(85%) were eligible for grouping. BMTBI contained `r nrow(BM_and_TBI_cohort)` patients; BM contained `r nrow(BM_no_TBI_cohort)` patients; TBI contained `r nrow(isolated_severe_tbi_cohort)` patients and PT contained `r nrow(penetrating_cohort)` patients. 932 patients lacked data about age, `r Missing[3]` patients lacked data about emergency department GCS and `r Missing[4]` patients lacked data about emergency department blood pressure. No patients lacked data about dominant injury type or AIS score.

```{r exclusion-flowchart, echo=FALSE, fig.cap="\\textbf{Stages of exclusion.} \\emph{Abbreviations: BMTBI = severe blunt multisystem injuries and a severe traumatic brain injury, BM = severe blunt multisystem injuries without a severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury.}", out.width="100%", fig.align="center"}
knitr::include_graphics("exclusion_flowchart.pdf")
```

 
## Descriptive data
Table \@ref(tab:descriptive-table) presents patient demographics in the trauma cohorts. The cohort with the lowest cumulative incidence of OFI was PT with 6.0%. Highest was BM with 18.9%. The sample population in its entirety had cumulative incidence of 5.8%. TBI had the highest 30-day-mortality with 36.5%. The study population is male-dominated with `r round(percent_male, digits=1)`% men. BMTBI had the highest NISS with 44.3.

```{r descriptive-table, echo=FALSE, warning=FALSE, message=FALSE, include=T}
options(kableExtra.auto_format = FALSE)
library(kableExtra)

t1kable(pt_demographics) %>% 
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "center") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "scale_down")

```


*Abbreviations: BMTBI = severe blunt multisystem injuries and a severe traumatic brain injury, BM = severe blunt multisystem injuries without a severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury, SD = standard deviation, ED SBP = emergency department systolic blood pressure, ED GCS = emergency department Glasgow coma scale sum, NISS = new injury severity score, Survival = survival status 30 days following emergency department admission.*


## Logistic regression
Table \@ref(tab:log-reg-table) outlines the results of a logistic regression analysis comparing cohort belonging and odds of OFI. There was markedly lower odds of experiencing OFI in PT compared to BM (OR = 0.27, p<0.01). Patients in BMTBI and TBI were also less likely to experience OFI than BM (OR = 0.42, p = 0.074 and OR = 0.67, p = 0.22 respectively), but did not meet our criteria for statistical significance. 

```{r log-reg-table, echo=FALSE, warning=FALSE, message = FALSE, include=T}
library(flextable)
library(dplyr)
## "Table 3:" can probably be made bold by "compose" in order to make the tables homogenous. Figure out a way of removing "Cohort" and citation notes on OR and CI: "1". 


set_flextable_defaults(fonts_ignore=TRUE)
log_reg_table %>%
  as_flex_table() %>%
  set_caption(caption = "Logistic regression. Association between cohort belonging and OFI.", style = "Table Caption") %>%
 delete_part(part = "footer") %>%
  theme_booktabs() %>%
  bold(part = "header")
```
*Abbreviations: BMTBI = severe blunt multisystem injuries and severe traumatic brain injury, BM = severe blunt multisystem injuries without severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury, Remaining = patients part of the initial sample, but not included in a cohort, CI = Confidence Interval, OR = Odds Ratio*


## Incidence 
Semiannual incidence of OFI for the study sample ranged from  `r round(min(incidence.data$incidence_all), digits=2)`% to   `r round(max(incidence.data$incidence_all), digits=2)`% (Figure \@ref(fig:incidence-graph)). TBI had the highest semiannual incidence with 35.7. For the duration of the study, overall semiannual incidence appears to be trending downwards, with a partial retracement in 2019. Cumulative incidence of OFI was unequally distributed across cohorts and its rate of increase varied significantly temporally within cohorts (Figure \@ref(fig:cumulative-incidence-graph)). 

```{r incidence-graph, fig.cap="\\textbf{Semiannual incidence of OFI.} Percentage of cases reviewed with OFI, measured with a six month interval (2017-2021). \\emph{Abbreviations: BMTBI = severe blunt multisystem injuries and a severe traumatic brain injury, BM = severe blunt multisystem injuries without a severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury, OFI = opportunities for improvement}", latex_options = "HOLD_position", echo=FALSE, warning=FALSE, out.width="85%", fig.align="center"}
library(ggplot2)
incidence_plot
```



```{r cumulative-incidence-graph, fig.cap="\\textbf{Cumulative incidence of OFI.} Cumulative percentage of total cohort participants with OFI (2017-2021). \\emph{Abbreviations: BMTBI = severe blunt multisystem injuries and a severe traumatic brain injury, BM = severe blunt multisystem injuries without a severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury, OFI = opportunities for improvement}", latex_options = "HOLD_position", echo=FALSE, warning=FALSE, out.width="85%", fig.align="center"}

library(ggplot2)
cum_incidence_plot 

```


```{r problem-area-barplot, fig.cap="\\textbf{Identification of specific improvement areas.} Percentage of total OFI in the overall trauma population attributable to specific improvement areas.", echo=FALSE, warning=FALSE, message=FALSE, out.width="85%"}
#library(ggplot2)
#library(ggthemes)
#problem_area_barplot
```


## Trends
Table \@ref(tab:trend-table) presents the outcome of a fitted linear model with a time series component. BMTBI had a positive trend estimate. The overall study sample, and the remaining cohorts had negative trend estimates. No trends were statistically significant. TBI had the steepest trend estimate and the lowest p-value (-0.0175, p = 0.089).

```{r trend-table, echo=FALSE, warning=FALSE, message = FALSE, include=T}
options(kableExtra.auto_format = FALSE)
library(kableExtra)

#Having problems choosing width. Padding argument doesn't seem to work in PDF, leaving me to choose either full_width=T or have a small table with no padding.

incidence_trend_table$Estimate <- round(incidence_trend_table$Estimate, digits = 4)
incidence_trend_table$P_value <- round(incidence_trend_table$P_value, digits = 4)

incidence_trend_table %>% 
  kbl(caption = "\\textbf{Temporal incidence trends.} The trend estimate represents the linear model's expected decline in incidence of OFI every 6 months.", col.names = c("Cohort","Estimate", "P value")) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "hold_position", position = "center")


```

*Abbreviations: BMTBI = severe blunt multisystem injuries and a severe traumatic brain injury, BM = severe blunt multisystem injuries without a severe traumatic brain injury, TBI = isolated severe traumatic brain injury, PT = severe penetrating truncal injury, CI = confidence interval.*

# Discussion
In this retrospective cohort study of severely injured adult trauma patients, we outlined and compared incidence of OFI across clinically relevant subsets of the trauma population and predicted temporal incidence trends. We found considerable variance in cumulative incidence of OFI across the trauma cohorts. The cumulative incidence of OFI of BM (17.7%) were markedly higher than that of the overall study sample (5.8%). The trend estimate of the overall study sample was negative, but did not meet our criteria for statistical significance.

The use of audit filters in the selection process favors patients with severe outcomes. Additionally, severity of injury correlates with complexity of management[@Complexity] and risk for errors in care. Injury severity should therefore be positively correlated with OFI and cohorts with a higher cumulative incidence of OFI would be expected to have a higher median NISS. Our results are not indicative of such a correlation. BMTBI had the highest NISS by far (median = 43), yet it had a cumulative incidence of less than half of that of BM (median NISS = 34) (see Table \@ref(tab:descriptive-table)). We further hypothesized that adding a new type of injury to an already injured patient would increase overall complexity of management and probability of OFI. We should then expect to see a higher cumulative incidence of OFI in BMTBI than in BM and TBI. Contrary to that assumption, BM had a considerably higher, and TBI a moderately higher cumulative incidence of OFI than BMTBI. An attempt at an interpretation would be to say that patients in BMTBI, as a consequence of the severity of their injuries, died before errors could be made. In contrast to TBI with a mortality ratio of 36,5%, however, the mortality ratio of BMTBI (25%) seems rather modest. Hence, we believe this to be an aberration attributable to a limited patient sample.

To our knowledge, this is the first study to investigate the distribution of OFI for different subsets of the trauma population. As a result, several of the findings presented in this paper are difficult to compare. The cumulative incidence of OFI for the total study sample was 5.8%. That is much lower than what has been recorded in previous studies[@Preventable_6; @HemorrhageOFI; @RwandaOFI]. As previously discussed, those studies have however differed much methodologically, either by choice of study population or by overall methods. A study by Ghorbani et al.[@Ghorbani2018], who looked at TRPD and preventable errors in deceased trauma patients treated at KUH between 2012 and 2016 is perhaps the study most similar to ours. They recorded preventable errors, which can be considered comparable to OFI, in 21% of deceased patients. That is much higher than what we recorded in our overall sample, but also hard to compare as we did not include deceased trauma patients as a cohort.

## Strengths and limitations
The study is population based and handles cross-referenced patient data from two large Scandinavian databases. It has a considerable population size and outcome data garnered from an extensive quality review process involving experts from each specialty involved in trauma care. Selection bias for the study in general is limited as the trauma population in our study matches the KUH trauma population. Bias in data handling, grouping and analyses is also limited as the associated methods were developed using artificial data and not changed post hoc. 

There are several limitations to this study. The method for patient selection to multidisciplinary morbidity and mortality review conferences relies on audit filters and nursing review. There is at present no consensus in the trauma literature as to which audit filters are effective[@CochraneAF]. Audit filters used at KUH have been chosen by an expert trauma committee consensus and may not accurately predict OFI. Consequently, there is a probability of selection bias as the choice of audit filters influences which patients are discussed. The same goes for selection via nursing review. Moreover, the limited number of patients in each cohort weakens the power of the logistic regression and the incidence trend analysis. 

## Implications
We have outlined the distribution of OFI across four trauma cohorts. This has clinical importance as it informs local quality improvement committees on where to focus their efforts. The main value of this article, however, is academic. Ours is the first study to examine rates of OFI within the general trauma population, as well as the first study to compare rates of OFI across clinically relevant subsets of the trauma population. 

## Generalisability 
Among other things, the use of audit filters[@CochraneAF], the structure of morbidity and mortality reviews[@MMCandSelection] and the panorama of injury differ across institutions. Moreover, our limited patient sample renders our study low in external validity. We can not say with any certainty that our findings would be replicated had our study been conducted elsewhere.

## Conclusion
Cumulative incidence of OFI was unequally distributed among the trauma cohorts. Patients with severe blunt multisystem injuries without a severe traumatic brain injury had higher odds of experiencing OFI than patients in the other cohorts. Future studies should continue to supplement the thin literature on rates of OFI and hitherto non-existent literature on distribution of OFI across the traumatic spectrum of injury. Moreover, they should seek to validate audit filters as an effective model for multidisciplinary morbidity and mortality review conference selection.

# References


