---
title: "Programming"
author: "Elias Joneborg"
date: "2/8/2022"
output: html_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library(tidyr)

swetrau_scrambled <- read.csv("swetrau-scrambled.csv")
problem_scrambled <- read.csv("problem-scrambled.csv")


problem_scrambled$OFI <- with(problem_scrambled, ifelse(Problemomrade_.FMP == "ok" | Problemomrade_.FMP == "OK" | Problemomrade_.FMP == "Ok" | Problemomrade_.FMP == "Föredömligt handlagd", "NO", "YES"))

problem_area<-na.omit(problem_scrambled)

swetrau_problem<- merge(swetrau_scrambled, problem_area, by= "id")

library(dplyr)

Swetrau_relevant<-swetrau_problem %>% select(inj_dominant, pt_age_yrs, OFI, NISS, ed_gcs_sum, pre_intub_type, pre_sbp_value, pre_sbp_rtscat, ed_sbp_value, ed_sbp_rtscat, 151:201, Ankomst_te)


#BLUNT MULTISYSTEM

is_serious <- function(code) {
  severity <- substr(as.character(code), 8, 8)
  as.numeric(severity) >= 3  # if severity level is 3 or higher, the injury is considered serious
}

####
# Identify distinct regions
####

# Expects a vector of codes
number_of_regions <- function(code) {
  region <- substr(as.character(code), 1, 1)
  length(unique(region))
}

###
# Putting them together
###

has_more_than_one_serious_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  number_of_regions(code[serious_injury]) >= 2
}

###
# Apply on dataset
###

# Creates column blunt_multisystem with TRUE/FALSE 

swetrau_scrambled$blunt_multisystem <- NA
swetrau2 <- swetrau_scrambled[!is.na(swetrau_scrambled$inj_dominant), ] #Need to remove not known in inj_dominant

for (i in 1:nrow(swetrau2)) {
  v = 0+i
  if (has_more_than_one_serious_injury(swetrau2[v,grepl( "AISCode" , names(swetrau_scrambled))]) == TRUE && swetrau2[v,"inj_dominant"] == 1) {
    swetrau2[v,"blunt_multisystem"] <- TRUE
  } else {
    swetrau2[v,"blunt_multisystem"] <- FALSE
  }
}

# SHOCK

swetrau2$ed_sbp_rtscat[is.na(swetrau2$ed_sbp_rtscat)]<-10
swetrau2$ed_sbp_below_90 <- with(swetrau2, ifelse(ed_sbp_value>=0 & swetrau2$ed_sbp_value<=90, TRUE, FALSE))
swetrau2$shock <- with(swetrau2, ifelse(ed_sbp_below_90 == TRUE | ed_sbp_rtscat <= 3, TRUE, FALSE))

#GERIATRIC

swetrau2$geriatric <- with(swetrau2, ifelse(pt_age_yrs>65 & pt_age_yrs<120, TRUE, FALSE))

#PENETRATING

neck_chest_abdomen_region <- function(code) {
  code <- code[!is.na(code)]
  region <- substr(as.character(code), 1, 1)
  as.numeric(region) >= 3 && as.numeric(region)<=5
}
    
serious_neck_chest_abdomen_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  neck_chest_abdomen_region(code[serious_injury])
}

swetrau2$penetrating <- NA
for (i in 1:nrow(swetrau2)) {
  v = 0+i
  if(serious_neck_chest_abdomen_injury(swetrau2[v,grepl( "AISCode" , names(swetrau2))]) == TRUE && swetrau2[v, "inj_dominant"] == 2) {
    swetrau2[v,"penetrating"] <- TRUE
  } else {
    swetrau2[v,"penetrating"] <- FALSE
  }
}

# Need assistance diagnosing why this code doesn't perform as it is supposed to

#SEVERE TBI

head_region <- function(code) {
  region <- substr(as.character(code), 1, 1)
  as.numeric(region) == 1
}

has_a_serious_head_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  head_region(code[serious_injury]) 
}

only_one_region <- function(code){
  number_of_regions(code) == 1
}

swetrau2$gcs_below_9 <- NA
swetrau2$gcs_below_9 <- with(swetrau2, ifelse(ed_gcs_sum<=8 | pre_intub_type==1, TRUE, FALSE))
swetrau2$gcs_below_9 <- with(swetrau2, ifelse(is.na(gcs_below_9) | isFALSE(gcs_below_9), FALSE, TRUE))

only_one_serious_injury_region <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  only_one_region(code[serious_injury])
}

swetrau2$severe_tbi <- NA

for (i in 1:nrow(swetrau2)) {
  v = 0+i
if (has_a_serious_head_injury(swetrau2[v, grepl("AISCode", names(swetrau2))]) == TRUE && only_one_serious_injury_region(swetrau2[v, grepl("AISCode", names(swetrau2))]) == TRUE && swetrau2[v, "gcs_below_9"] == TRUE) {
    swetrau2[v,"severe_tbi"] <- TRUE
  } else {
    swetrau2[v,"severe_tbi"] <- FALSE
  }
}
#Not entirely sure that this does what it is supposed to do since there are only 4 "TRUE"s. The simulated data set does however not allow for many participants in this cohort as there are 30 AIS scores and only one has to be severe and in a non head region in order for the row to be excluded.

#TABLE ONE

shock_cohort <- filter(swetrau2, shock == "TRUE")
geriatric_cohort <- filter(swetrau2, geriatric == "TRUE")
penetrating_cohort <- filter(swetrau2, penetrating == "TRUE")
blunt_multisystem_cohort <- filter(swetrau2, blunt_multisystem == "TRUE")
severe_tbi_cohort <-filter(swetrau2, severe_tbi == "TRUE")
  
 geriatric_cohort$Cohort <- "Geriatric"
 penetrating_cohort$Cohort <- "Penetrating"
 severe_tbi_cohort$Cohort <- "Severe TBI"
 shock_cohort$Cohort <- "Shock"
 blunt_multisystem_cohort$Cohort <- "Blunt multisystem"
 
  merged_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(geriatric_cohort, penetrating_cohort, blunt_multisystem_cohort, shock_cohort, severe_tbi_cohort))

  library(table1)

                  label(merged_cohorts$NISS)              <- "New Injury Severity Score"
                  label(merged_cohorts$pre_sbp_value)    <- "Pre Hospital Systolic BP"
                  label(merged_cohorts$ed_sbp_value)     <- "Emergency Department Systolic BP"
                  label(merged_cohorts$pt_age_yrs)        <- "Age"
                  
                  units(merged_cohorts$pre_sbp_value)  <- "mmHg"
                  units(merged_cohorts$ed_sbp_value)   <- "mmHg"
                  units(merged_cohorts$pt_age_yrs)    <-"Years"

                  table1(~ pt_age_yrs + NISS + pre_sbp_value + ed_sbp_value | Cohort, data=merged_cohorts,overall = FALSE)
     
#Since the cohorts are merged in a manner allowing for duplicates, the "overall" number will not match the total number of participants, but the sum of the cohorts.                              
                  
# FLOWCHART

# Testing two different flowchart types
                  
library(PRISMAstatement)

flow_exclusions(
  incl_counts = c(nrow(problem_scrambled),nrow(problem_area), nrow(swetrau_problem), nrow(Swetrau_relevant),nrow(swetrau2)),
total_label = "Trauma Care Quality Registry",
  incl_labels = c("Complete data", "Eligible for cohort inclusion", "XXXX","XXX"),
  excl_labels = c("Missing data", "Ineligible for cohort inclusion", "XXXX", "XXX")
)
              
 # FLOWCHART
                  
              
library(DiagrammeR)
                  
grViz("digraph flowchart {

      node [fontname = Helvetica, shape = rectangle]        
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']
      tab7 [label = '@@7']
      tab8 [label = '@@8']

      tab1 -> tab2
      tab2 -> tab3 
      tab3 -> tab4
      tab3 -> tab5
      tab3 -> tab6
      tab3 -> tab7
      tab3 -> tab8
      }

      [1]: 'Trauma Care Quality Registry n=12099'
      [2]: 'Complete data n=11522 '
      [3]: 'Eligible for cohort inclusion n=8226'
      [4]: 'Blunt multisystem n=3296'
      [5]: 'Geriatric n=2053'
      [6]: 'Penetrating n=2024'
      [7]: 'Severe TBI n=2417'
      [8]: 'Shock n=1656'
      ")   


# INCIDENCE
                               
library(incidence)

get_year <- function(code) {
  year <- substr(as.character(code), 1, 4)
  as.character(year)
  }
    
get_month <- function(code) {
  month <- substr(as.character(code), 5, 6)
  as.character(month)
}

get_day <- function(code) {
  day <- substr(as.character(code), 7, 8)
  as.character(day)
  }

Swetrau_relevant$date <-paste(get_year(Swetrau_relevant$Ankomst_te), get_month(Swetrau_relevant$Ankomst_te), get_day(Swetrau_relevant$Ankomst_te), sep = "-")

Swetrau_relevant$OFI <- with(Swetrau_relevant, ifelse(OFI== "YES", "Opportunities for Improvement","Case well handled"))

dat <- Swetrau_relevant$date

incidence_OFI <- incidence(dat, interval = "month", groups = Swetrau_relevant$OFI)
plot(incidence_OFI, stack = TRUE, border = "grey")

```

                  
