---
title: "Programming"
author: "Elias Joneborg"
date: "2/8/2022"
output: html_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

library(tidyr)

swetrau_scrambled <- read.csv("swetrau-scrambled.csv")
problem_scrambled <- read.csv("problem-scrambled.csv")


problem_scrambled$OFI <- with(problem_scrambled, ifelse(Problemomrade_.FMP == "ok" | Problemomrade_.FMP == "OK" | Problemomrade_.FMP == "Ok" | Problemomrade_.FMP == "Föredömligt handlagd", "NO", "YES"))

problem_area<-na.omit(problem_scrambled)

swetrau_problem<- merge(swetrau_scrambled, problem_area, by= "id", all.y = TRUE)

library(dplyr)

### DATA CLEANING

# remove NA:s 

#swetrau_problem$ed_sbp_value[swetrau_problem$ed_sbp_value == 999] = NA
#swetrau_problem$ed_gcs_sum[swetrau_problem$ed_gcs_sum == 999] = NA
#swetrau_problem$inj_dominant[swetrau_problem$inj_dominant == 999] = NA

#na_omit_ed_sbp <-swetrau_problem[!is.na(swetrau_problem$ed_sbp_value),]
#na_omit_sbp_gcs <- na_omit_ed_sbp[!is.na(na_omit_ed_sbp$ed_gcs_sum),]
#na_omit_sbp_gcs_age <- na_omit_sbp_gcs[!is.na(na_omit_sbp_gcs$pt_age_yrs),]
#na_omit_sbp_gcs_age_inj <- na_omit_sbp_gcs_age[!is.na(na_omit_sbp_gcs_age$inj_dominant),]


#can be integrated in flowchart below
#further data points, used in e.g. table one can be cleaned when the relevant variables are decided

# significant loss of participants

swetrau_select<-swetrau_problem %>% select(inj_dominant, pt_age_yrs, OFI, NISS, ed_gcs_sum, pre_intub_type, pre_sbp_value, pre_sbp_rtscat, ed_sbp_value, ed_sbp_rtscat, Ankomst_te, starts_with("AISCode"))

### COHORT GROUPING ###

#BLUNT MULTISYSTEM

is_serious <- function(code) {
  severity <- substr(as.character(code), 8, 8)
  as.numeric(severity) >= 3  # if severity level is 3 or higher, the injury is considered serious
}

####
# Identify distinct regions
####

# Expects a vector of codes
number_of_regions <- function(code) {
  region <- substr(as.character(code), 1, 1)
  length(unique(region))
}

###
# Putting them together
###

has_more_than_one_serious_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  number_of_regions(code[serious_injury]) >= 2
}

###
# Apply on dataset
###

# Creates column blunt_multisystem with TRUE/FALSE 

swetrau_select$blunt_multisystem <- NA
swetrau_relevant <-swetrau_select[!is.na(swetrau_select$inj_dominant), ] #Need to remove not known in inj_dominant

for (i in 1:nrow(swetrau_relevant)) {
  v = 0+i
  if (has_more_than_one_serious_injury(swetrau_relevant[v,grepl( "AISCode" , names(swetrau_relevant))]) == TRUE && swetrau_relevant[v,"inj_dominant"] == 1) {
    swetrau_relevant[v,"blunt_multisystem"] <- TRUE
  } else {
    swetrau_relevant[v,"blunt_multisystem"] <- FALSE
  }
}

# SHOCK

swetrau_relevant$ed_sbp_rtscat[is.na(swetrau_relevant$ed_sbp_rtscat)]<-10 #JA: Vad gör du här?
swetrau_relevant$ed_sbp_below_90 <- with(swetrau_relevant, ifelse(ed_sbp_value>=0 & swetrau_relevant$ed_sbp_value<=90, TRUE, FALSE))
swetrau_relevant$shock <- with(swetrau_relevant, ifelse(ed_sbp_below_90 == TRUE | ed_sbp_rtscat <= 3, TRUE, FALSE))

#GERIATRIC

swetrau_relevant$geriatric <- with(swetrau_relevant, ifelse(pt_age_yrs>65 & pt_age_yrs<120, TRUE, FALSE))

#PENETRATING

vector_of_codes <- c(300452.6, 200082.2, 237192.6, 432121.1, 123321.2, 121331.5)

#is.element() generates vector - true/false 

neck_chest_abdomen_region <- function(code) {
  code <- code[!is.na(code)]
  region <- substr(as.character(code), 1, 1)  
  is.element(region,3:5)
}

#sum() adds up number of times a specific vector is presented

serious_neck_chest_abdomen_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  sum(neck_chest_abdomen_region(code[serious_injury]) == TRUE )
}

swetrau_relevant$penetrating <- NA
for (i in 1:nrow(swetrau_relevant)) {
  v = 0+i
  if(serious_neck_chest_abdomen_injury(swetrau_relevant[v,grepl( "AISCode" , names(swetrau_relevant))]) >= 1 && swetrau_relevant[v, "inj_dominant"] == 2) {
    swetrau_relevant[v,"penetrating"] <- TRUE
  } else {
    swetrau_relevant[v,"penetrating"] <- FALSE
  }
}


#SEVERE TBI

AIS_1 <- c(300452.6, 200082.2, 237192.6, 432121.3, 123321.2)
AIS_2 <- c(300322.1, 565232.1, 234145.2, 421441.1, 312131.1)
AIS_3 <- c(100212.4, 531212.1, 223233.1, 321212.2, 232232.1)
AIS_4 <- c(100212.4, 200212.3, 100212.1, 100212.2, 100212.2)
AIS_5 <- c(100212.4, 100212.3, 100212.4, 100212.5, 100212.1)
df_AIS_vector <- data.frame(AIS_1, AIS_2, AIS_3, AIS_4, AIS_5)

head_region <- function(code) {
  region <- substr(as.character(code), 1, 1)
  is.element(region, 1)
}

#returns true if body region == 1

has_a_serious_head_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  head_region(code[serious_injury]) 
}

#acts on vectors in "serious_injury", chooses those which have region == 1

only_one_region <- function(code){
  number_of_regions(code) == 1
}

#chooses those with one region and returns TRUE/FALSE

only_one_serious_injury_region <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  only_one_region(code[serious_injury])
}
#starts with those with a serious injury and returns TRUE/FALSE depending on there being more than one unique region in entire row

swetrau_relevant$gcs_below_9 <- NA
swetrau_relevant$gcs_below_9 <- with(swetrau_relevant, ifelse(ed_gcs_sum<=8 | pre_intub_type==1, TRUE, FALSE))
swetrau_relevant$gcs_below_9 <- with(swetrau_relevant, ifelse(is.na(gcs_below_9) | isFALSE(gcs_below_9), FALSE, TRUE))

#makes new variable with those with a GCS <9 and those intubated in a prehospital setting. Converts NA to FALSE.

swetrau_relevant$severe_tbi <- NA

for (i in 1:nrow(swetrau_relevant)) {
  v = 0+i
if (has_a_serious_head_injury(swetrau_relevant[v, grepl("AISCode", names(swetrau_relevant))]) == TRUE && only_one_serious_injury_region(swetrau_relevant[v, grepl("AISCode", names(swetrau_relevant))]) == TRUE && swetrau_relevant[v, "gcs_below_9"] == TRUE) {
    swetrau_relevant[v,"severe_tbi"] <- TRUE
  } else {
    swetrau_relevant[v,"severe_tbi"] <- FALSE
  }
}
#returns TRUE if row has serious head injury AND no serious injury in other body region


### COHORT DEMOGRAPHICS


#Table 1

swetrau_relevant$OFI <- with(swetrau_relevant, ifelse(OFI== "YES", "Opportunities for Improvement","Case well handled"))

shock_cohort <- filter(swetrau_relevant, shock == "TRUE")
geriatric_cohort <- filter(swetrau_relevant, geriatric == "TRUE")
penetrating_cohort <- filter(swetrau_relevant, penetrating == "TRUE")
blunt_multisystem_cohort <- filter(swetrau_relevant, blunt_multisystem == "TRUE")
severe_tbi_cohort <-filter(swetrau_relevant, severe_tbi == "TRUE")
  
 geriatric_cohort$Cohort <- "Geriatric"
 penetrating_cohort$Cohort <- "Penetrating"
 severe_tbi_cohort$Cohort <- "Severe TBI"
 shock_cohort$Cohort <- "Shock"
 blunt_multisystem_cohort$Cohort <- "Blunt multisystem"
 
  merged_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(geriatric_cohort, penetrating_cohort, blunt_multisystem_cohort, shock_cohort, severe_tbi_cohort))

  library(table1)

                  label(merged_cohorts$NISS)              <- "New Injury Severity Score"
                  label(merged_cohorts$pre_sbp_value)    <- "Pre Hospital Systolic BP"
                  label(merged_cohorts$ed_sbp_value)     <- "Emergency Department Systolic BP"
                  label(merged_cohorts$pt_age_yrs)        <- "Age"
                  
                  label(merged_cohorts$OFI)               <- "Opportunities for improvement"
                  
                  units(merged_cohorts$pre_sbp_value)  <- "mmHg"
                  units(merged_cohorts$ed_sbp_value)   <- "mmHg"
                  units(merged_cohorts$pt_age_yrs)    <-"Years"
                  

                  table1(~ OFI + pt_age_yrs + NISS + pre_sbp_value + ed_sbp_value | Cohort, data=merged_cohorts,overall = FALSE)
     
#Since cohorts are merged in a manner allowing for duplicates, the "overall" number will not match the total number of participants, but the sum of the cohorts. 
                  
                  
### FLOWCHART

 # Making data frame with nrow of relevant df:s to be used as reference in code below                 
   a <- c(0,1)               
   a$a <- nrow(problem_scrambled)   
   a <- as.data.frame(a)
   a$b <- nrow(problem_area)
   a$c <- nrow(swetrau_relevant)
   a$d <- nrow(blunt_multisystem_cohort)
   a$e <- nrow(penetrating_cohort)
   a$f <- nrow(severe_tbi_cohort)
   a$g <- nrow(shock_cohort)
   a$h <- nrow(geriatric_cohort)                      
                  
library(DiagrammeR)

DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot]

node [shape = rectangle, width = 4, fillcolor = Biege]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@4']
f [label = '@@5']
g [label = '@@6']
h [label = '@@7']


a -> b -> c -> d 
c -> e
c -> f
c -> g
c -> h
          
}

[1]: paste0('Trauma care quality database (n = ', a$a, ')')
[2]: paste0('Known problem area (n = ', a$b, ')')
[3]: paste0('Known dominant injury (n = ', a$c, ')')
[4]: paste0('Blunt multisystem (n = ', a$d, ')')
[5]: paste0('Penetrating (n = ', a$e, ')')
[6]: paste0('Severe TBI (n = ', a$f, ')')
[7]: paste0('Shock (n = ', a$g, ')')
[8]: paste0('Geriatric (n = ', a$h, ')')

")


#### INCIDENCE

                               
library(incidence)

get_year <- function(code) {
  year <- substr(as.character(code), 1, 4)
  as.character(year)
  }
    
get_month <- function(code) {
  month <- substr(as.character(code), 5, 6)
  as.character(month)
}

get_day <- function(code) {
  day <- substr(as.character(code), 7, 8)
  as.character(day)
  }

swetrau_relevant$date <-paste(get_year(swetrau_relevant$Ankomst_te), get_month(swetrau_relevant$Ankomst_te), get_day(swetrau_relevant$Ankomst_te), sep = "-")

swetrau_relevant$date <- as.Date(swetrau_relevant$date)

dat <- swetrau_relevant$date

# Use of incidence package to calculate incidence in the group as a whole by year 

incidence_OFI <- incidence(dat, interval = "year", groups = swetrau_relevant$OFI)
library(scales)
library(ggplot2)
plot(incidence_OFI, stack = TRUE, border = "grey")





### TOTAL YEARLY INCIDENCE OF OFI


merged_cohorts$date <-paste(get_year(merged_cohorts$Ankomst_te), get_month(merged_cohorts$Ankomst_te), get_day(merged_cohorts$Ankomst_te), sep = "-")

merged_cohorts$date <- as.Date(merged_cohorts$date)

arrival_date <- merged_cohorts$date

incidence_OFI_1 <- incidence(arrival_date, interval = "year", groups = merged_cohorts$OFI)

incidence_OFI_1 <- as.data.frame(incidence_OFI_1)

incidence_OFI_1$tot_yearly_incidence <- incidence_OFI_1$"Opportunities for Improvement" / (incidence_OFI_1$"Opportunities for Improvement" + incidence_OFI_1$"Case well handled") * 100





### COHORT YEARLY INCIDENCE OF OFI


## Blunt

blunt_multisystem_cohort$date <-paste(get_year(blunt_multisystem_cohort$Ankomst_te), get_month(blunt_multisystem_cohort$Ankomst_te), get_day(blunt_multisystem_cohort$Ankomst_te), sep = "-")

blunt_multisystem_cohort$date <- as.Date(blunt_multisystem_cohort$date)

blunt_year <- blunt_multisystem_cohort$date

blunt_incidence_OFI <- incidence(blunt_year, interval = "year", groups = blunt_multisystem_cohort$OFI)

blunt_incidence_OFI <- as.data.frame(blunt_incidence_OFI)

blunt_incidence_OFI$blunt_yearly_incidence <- blunt_incidence_OFI$"Opportunities for Improvement" / (blunt_incidence_OFI$"Opportunities for Improvement" + blunt_incidence_OFI$"Case well handled") * 100

## Penetrating

penetrating_cohort$date <-paste(get_year(penetrating_cohort$Ankomst_te), get_month(penetrating_cohort$Ankomst_te), get_day(penetrating_cohort$Ankomst_te), sep = "-")

penetrating_cohort$date <- as.Date(penetrating_cohort$date)

penetrating_year <- penetrating_cohort$date

penetrating_incidence_OFI <- incidence(penetrating_year, interval = "year", groups = penetrating_cohort$OFI)

penetrating_incidence_OFI <- as.data.frame(penetrating_incidence_OFI)

penetrating_incidence_OFI$penetrating_yearly_incidence <- penetrating_incidence_OFI$"Opportunities for Improvement" / (penetrating_incidence_OFI$"Opportunities for Improvement" + penetrating_incidence_OFI$"Case well handled") * 100

## Severe TBI

severe_tbi_cohort$date <-paste(get_year(severe_tbi_cohort$Ankomst_te), get_month(severe_tbi_cohort$Ankomst_te), get_day(severe_tbi_cohort$Ankomst_te), sep = "-")

severe_tbi_cohort$date <- as.Date(severe_tbi_cohort$date)

severe_tbi_year <- severe_tbi_cohort$date

severe_tbi_incidence_OFI <- incidence(severe_tbi_year, interval = "year", groups = severe_tbi_cohort$OFI)

severe_tbi_incidence_OFI <- as.data.frame(severe_tbi_incidence_OFI)
severe_tbi_incidence_OFI$"Case well handled" <- 0

severe_tbi_incidence_OFI$severe_tbi_yearly_incidence <- severe_tbi_incidence_OFI$"Opportunities for Improvement" / (severe_tbi_incidence_OFI$"Opportunities for Improvement" + severe_tbi_incidence_OFI$"Case well handled") * 100


## Geriatric

geriatric_cohort$date <-paste(get_year(geriatric_cohort$Ankomst_te), get_month(geriatric_cohort$Ankomst_te), get_day(geriatric_cohort$Ankomst_te), sep = "-")

geriatric_cohort$date <- as.Date(geriatric_cohort$date)

geriatric_year<- geriatric_cohort$date

geriatric_incidence_OFI <- incidence(geriatric_year, interval = "year", groups = geriatric_cohort$OFI)

geriatric_incidence_OFI <- as.data.frame(geriatric_incidence_OFI)

geriatric_incidence_OFI$geriatric_yearly_incidence <- geriatric_incidence_OFI$"Opportunities for Improvement" / (geriatric_incidence_OFI$"Opportunities for Improvement" + geriatric_incidence_OFI$"Case well handled") * 100

## Shock

shock_cohort$date <-paste(get_year(shock_cohort$Ankomst_te), get_month(shock_cohort$Ankomst_te), get_day(shock_cohort$Ankomst_te), sep = "-")

shock_cohort$date <- as.Date(shock_cohort$date)

shock_year <- shock_cohort$date

shock_incidence_OFI <- incidence(shock_year, interval = "year", groups = shock_cohort$OFI)

shock_incidence_OFI <- as.data.frame(shock_incidence_OFI)

shock_incidence_OFI$shock_yearly_incidence <- shock_incidence_OFI$"Opportunities for Improvement" / (shock_incidence_OFI$"Opportunities for Improvement" + shock_incidence_OFI$"Case well handled") * 100





### PLOTTING COHORT INCIDENCE USING "INCIDENCE PACKAGE"


merged_cohorts_2 <- filter(merged_cohorts, OFI == "Opportunities for Improvement")

merged_cohorts_2$date <-paste(get_year(merged_cohorts_2$Ankomst_te), get_month(merged_cohorts_2$Ankomst_te), get_day(merged_cohorts_2$Ankomst_te), sep = "-")

# Since each case here is "OFI == YES", number of dates is all we need to calculate

date <- merged_cohorts_2$date

cohort_incidence_OFI <-incidence(date, interval = "year", groups = merged_cohorts_2$Cohort)

plot(cohort_incidence_OFI)

# Incidence package uses incidence as "number of cases occurring per specified unit of time", ergo not as a proportion or percentage.





### TOTAL CUMULATIVE INCIDENCE (year)


incidence_percentage_OFI  <- as.data.frame(incidence_OFI)

get_percentage_tot<- function(x){
OFI_percentage <- (x) / c(nrow(swetrau_relevant)) * 100
 return(OFI_percentage)
}

## Incidence to incidence percentage (of total)


incidence_percentage_OFI$"Opportunities for Improvement" <- get_percentage_tot(incidence_percentage_OFI$"Opportunities for Improvement")

incidence_percentage_OFI$OFI_percentage<- incidence_percentage_OFI$"Opportunities for Improvement"

incidence_percentage_OFI <- transform(incidence_percentage_OFI, cum_inc = cumsum(OFI_percentage))





### COHORT CUMULATIVE INCIDENCE (year)


cohort_incidence_OFI <- incidence(date, interval = "year", groups = merged_cohorts_2$Cohort)

cohort_incidence_OFI <- as.data.frame(cohort_incidence_OFI)

## Blunt

get_percentage_blunt<- function(x){
blunt_OFI_percentage <- (x) / c(nrow(blunt_multisystem_cohort)) * 100
 return(blunt_OFI_percentage)
}

# Extracts % of cohort n

cohort_incidence_OFI$blunt_OFI_percentage <- get_percentage_blunt(cohort_incidence_OFI$"Blunt multisystem")

cohort_incidence_OFI <- transform(cohort_incidence_OFI, blunt_cum_inc = cumsum(blunt_OFI_percentage))

# Adds column with cumulative %


## Penetrating

get_percentage_penetrating<- function(x){
pen_OFI_percentage <- (x) / c(nrow(penetrating_cohort)) * 100
 return(pen_OFI_percentage)
}

cohort_incidence_OFI$pen_OFI_percentage <- get_percentage_penetrating(cohort_incidence_OFI$"Penetrating")

cohort_incidence_OFI <- transform(cohort_incidence_OFI, pen_cum_inc = cumsum(pen_OFI_percentage))


## Severe TBI

get_percentage_TBI<- function(x){
TBI_OFI_percentage <- (x) / c(nrow(severe_tbi_cohort)) * 100
 return(TBI_OFI_percentage)
}

cohort_incidence_OFI$TBI_OFI_percentage <- get_percentage_TBI(cohort_incidence_OFI$Severe.TBI)

cohort_incidence_OFI <- transform(cohort_incidence_OFI, TBI_cum_inc = cumsum(TBI_OFI_percentage))


## Geriatric

get_percentage_geriatric<- function(x){
ger_OFI_percentage <- (x) / c(nrow(geriatric_cohort)) * 100
 return(ger_OFI_percentage)
}

cohort_incidence_OFI$ger_OFI_percentage <- get_percentage_geriatric(cohort_incidence_OFI$Geriatric)

cohort_incidence_OFI <- transform(cohort_incidence_OFI, ger_cum_inc = cumsum(ger_OFI_percentage))

## Shock

get_percentage_shock<- function(x){
shock_OFI_percentage <- (x) / c(nrow(shock_cohort)) * 100
 return(shock_OFI_percentage)
}

cohort_incidence_OFI$shock_OFI_percentage <- get_percentage_shock(cohort_incidence_OFI$Shock)

cohort_incidence_OFI <- transform(cohort_incidence_OFI, shock_cum_inc = cumsum(shock_OFI_percentage))





### MERGING OF RESULTS INTO SINGLE DF

shock_incidence_OFI<- shock_incidence_OFI %>% select(dates, shock_yearly_incidence)
blunt_incidence_OFI<- blunt_incidence_OFI %>% select(dates, blunt_yearly_incidence)
penetrating_incidence_OFI<- penetrating_incidence_OFI %>% select(dates, penetrating_yearly_incidence)
geriatric_incidence_OFI<- geriatric_incidence_OFI %>% select(dates, geriatric_yearly_incidence)
severe_tbi_incidence_OFI <- severe_tbi_incidence_OFI %>% select(dates, severe_tbi_yearly_incidence)
incidence_percentage_OFI<- incidence_percentage_OFI %>% select(dates, cum_inc)
incidence_OFI_1 <-incidence_OFI_1 %>% select(dates, tot_yearly_incidence)

merged_incidence_table <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(incidence_OFI_1, blunt_incidence_OFI, penetrating_incidence_OFI, severe_tbi_incidence_OFI, geriatric_incidence_OFI, shock_incidence_OFI, cohort_incidence_OFI, incidence_percentage_OFI, by = "dates"))


merged_incidence_table <-subset(merged_incidence_table, select = -c(Blunt.multisystem, Geriatric, Penetrating, Severe.TBI, Shock, blunt_OFI_percentage, pen_OFI_percentage, TBI_OFI_percentage, ger_OFI_percentage, shock_OFI_percentage, y))

merged_incidence_table$severe_tbi_yearly_incidence[is.na(merged_incidence_table$severe_tbi_yearly_incidence)] = 0
# temporary condition




### PLOTTING AND TABULATION

library("reshape2")
library(ggplot2)
library("ggthemes")

#Yearly incidence as %
plot_inc_year <- merged_incidence_table %>% select(dates, tot_yearly_incidence, blunt_yearly_incidence, penetrating_yearly_incidence, severe_tbi_yearly_incidence, geriatric_yearly_incidence, shock_yearly_incidence)

plot_inc_year_long <- melt(plot_inc_year, id.vars = "dates")

ggplot(plot_inc_year_long,
       aes(x=dates,
           y=value,
           col = variable)) + 
  geom_line(size = 1.0, alpha = 1.0) +
  labs(title = "Yearly incidence of OFI in the KUH trauma care quality database",
       x = "Year",
       y = "%") +
  theme_minimal() +
  theme(axis.title = element_text())

#Cumulative incidence
plot_cum_inc<-merged_incidence_table %>% select(dates, cum_inc, blunt_cum_inc, pen_cum_inc, TBI_cum_inc, ger_cum_inc, shock_cum_inc)

plot_cum_inc_long <- melt(plot_cum_inc, id.vars = "dates")

ggplot(plot_cum_inc_long,
       aes(x=dates,
           y=value,
           col = variable)) + 
  geom_line(size = 1.0, alpha = 1.0) +
  labs(title = "Cumulative incidence of OFI in the KUH trauma care quality database by year",
       x = "Year",
       y = "% of total") +
  theme_minimal() +
  theme(axis.title = element_text())




### HISTOGRAM CONTAINING YEARLY M&M PARTICIPANTS AS % OF YEARLY SWETRAU PARTICIPANTS

swetrau_scrambled_date <-substr(as.character(swetrau_scrambled$DateTime_ArrivalAtHospital),1,10)





```

                  
