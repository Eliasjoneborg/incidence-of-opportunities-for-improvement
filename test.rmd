---
title: "Programming.cleaned.up"
author: "Elias Joneborg"
date: "3/16/2022"
output: pdf_document
---
 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}

#Necessary packages
library(dplyr)
library(plyr)
library(incidence)
library(scales)
library(ggplot2)
library(reshape2)
library(ggthemes)
library(DiagrammeR)
library(table1)
library(jtools)
library(ggstance)
library(lubridate)
library(webshot)

library("keyring")
library("DBI")
library("RMariaDB")
library("readr")
library(dotenv)


conn <- DBI::dbConnect(drv = RMariaDB::MariaDB(),
                       user = "eliasj",
                      password = Sys.getenv("DB_PASSWORD"),
                      db = "opportunities_for_improvement")

dataset.names <- setNames(nm = c("swetrau", "fmp", "atgarder", "problem"))


datasets <- lapply(dataset.names, function(dataset.name) dbReadTable(conn = conn, name = dataset.name))




attach(datasets)

swetrau$arrival <- as.POSIXct(strptime(swetrau$DateTime_ArrivalAtHospital, format = "%Y-%m-%d %H:%M"))
fmp$arrival <- as.POSIXct(strptime(fmp$Ankomst_te, format = "%Y%m%d %H:%M"))
problem$arrival <- as.POSIXct(strptime(problem$Ankomst_te, format = "%Y%m%d %H:%M"))
swetrau$id <- paste(swetrau$arrival, swetrau$PersonIdentity, swetrau$TempIdentity)
fmp$id <- paste(fmp$arrival, fmp$Personnummer, fmp$Reservnummer)
problem$id <- paste(problem$arrival, problem$Personnummer, problem$Reservnummer)

## Combine datasets
combined.datasets <- merge(fmp, problem, by = "id", all.x = TRUE)
combined.datasets <- merge(combined.datasets, swetrau, by = "id", all.x = TRUE)
detach(datasets)

create_ofi <- function(data) {
    ## Check arguments
    assertthat::assert_that(is.data.frame(data))
    assertthat::assert_that(all(c("VK_avslutad", "Problemomrade_.FMP", "Fr1.14") %in% names(data)))
    ## Create ofi variable
    data$Problemomrade_.FMP <- tolower(data$Problemomrade_.FMP)
    levels.Problemomrade_.FMP <- unique(data$Problemomrade_.FMP)
    original.levels.Problemomrade_.FMP <- c(NA, "ok", "triage på akutmottagningen",
                                            "resurs", "lång tid till op", "lång tid till dt",
                                            "vårdnivå", "traumakriterier/styrning",
                                            "missad skada", "kommunikation", "neurokirurg",
                                            "föredömligt handlagd", "logistik/teknik",
                                            "dokumentation", "dokumetation", "bristande rutin", 
                                            "handläggning", "kompetens brist", "tertiär survey")
    if (!all(levels.Problemomrade_.FMP %in% original.levels.Problemomrade_.FMP))
        stop ("Levels in Problemomrade._FMP have changed.")
    levels.Fr1.14 <- unique(data$`Fr1.14`)
    original.levels.Fr1.14 <- c(NA, "1", "3", "2", "999")
    if (!all(levels.Fr1.14 %in% original.levels.Fr1.14))
        stop ("Levels in Fr1.14 have changed.")
    prob.filters <- with(data, Problemomrade_.FMP != "ok" & Problemomrade_.FMP != "föredömligt handlagd")
    prob.mortality <- with(data, Fr1.14 == "2" | Fr1.14 == "3")
    prob <- prob.filters | prob.mortality
    data$VK_avslutad <- tolower(data$VK_avslutad)
    levels.VK_avslutad <- unique(data$VK_avslutad)
    original.levels.VK_avslutad <- c("ja", NA, "nej")
    if (!all(levels.VK_avslutad %in% original.levels.VK_avslutad))
        stop ("Levels in VK_avslutad have changed.")
    quality.process.done <- data$VK_avslutad == "ja"
    ofi <- ifelse(prob, "Yes",
           ifelse(quality.process.done & !prob, "No", NA))
    ofi[quality.process.done & is.na(prob)] <- "No"
    return (ofi)
}


 combined.datasets$OFI <- create_ofi(combined.datasets) 

 swetrau_problem_merged <- combined.datasets

swetrau_problem_merged$OFI <- with(swetrau_problem_merged, ifelse(is.na(OFI) | OFI == "No", "No", "Yes")) 

kNown_problem_area <-swetrau_problem_merged[!is.na(swetrau_problem_merged$OFI),]
#remove unkNown problem area

age_over_14 <- filter(kNown_problem_area, pt_age_yrs>14)

fewer_variables<-age_over_14 %>% select(id,inj_dominant, pt_age_yrs, Gender, OFI, NISS, ed_gcs_sum, pre_intub_type, pre_sbp_value, pre_sbp_rtscat, ed_sbp_value, ed_sbp_rtscat, arrival, starts_with("AISCode"))
#removing unnecessary variables


## Changing 999 to NA for grouping into cohorts

fewer_variables$ed_sbp_value[fewer_variables$ed_sbp_value == 999] = NA
fewer_variables$ed_sbp_rtscat[fewer_variables$ed_sbp_rtscat == 999] = NA
fewer_variables$ed_gcs_sum[fewer_variables$ed_gcs_sum == 999] = NA
fewer_variables$inj_dominant[fewer_variables$inj_dominant == 999] = NA

fewer_variables$Gender[fewer_variables$Gender == "M"] = "Male"
fewer_variables$Gender[fewer_variables$Gender == "K"] = "Female"


### COHORT GROUPING ###

## The functions below expect a row of AIS codes as input

#BLUNT MULTISYSTEM
is_serious <- function(code) {
  severity <- substr(as.character(code), 8, 8)
  as.numeric(severity) >= 3  
}
#if severity level is 3 or higher, the injury is considered serious

number_of_regions <- function(code) {
  region <- substr(as.character(code), 1, 1)
  length(unique(region))
}
#identifying number of regions

has_more_than_one_serious_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  number_of_regions(code[serious_injury]) >= 2
}

## combining them
blunt.multisystem <- apply(fewer_variables[1:100, ], 1, function(row) {
    code <- row[grep("AISCode", names(row))]
    row
})

fewer_variables$blunt_multisystem <- NA
#creating column blunt_multisystem

kNown_dominant_injury <-fewer_variables[!is.na(fewer_variables$inj_dominant), ] 
#removing Not kNown in inj_dominant

for (i in 1:nrow(kNown_dominant_injury)) {
  v = 0+i
  if (has_more_than_one_serious_injury(kNown_dominant_injury[v,grepl( "AISCode" , names(kNown_dominant_injury))]) == TRUE && kNown_dominant_injury[v,"inj_dominant"] == 1) {
    kNown_dominant_injury[v,"blunt_multisystem"] <- TRUE
  } else {
    kNown_dominant_injury[v,"blunt_multisystem"] <- FALSE
  }
}
#blunt multisystem <- TRUE/FALSE 

## The above for loop could be replaced with the more R:ish apply function below, which is substantially faster (at least on my low performing machine)

kNown_dominant_injury$blunt_multisystem <- apply(kNown_dominant_injury, 1, function(row) {
    code <- row[grep("AISCode", names(row))] 
    has_more_than_one_serious_injury(code) && row["inj_dominant"] == "1"
})

#SHOCK
bp_is_na <- with(fewer_variables, is.na(ed_sbp_rtscat) & is.na(ed_sbp_value))    
kNown_blood_pressure <- fewer_variables[!bp_is_na,]  
#removing rows with na in both sbp value and rts
     
kNown_blood_pressure$ed_sbp_rtscat[is.na(kNown_blood_pressure$ed_sbp_rtscat)]<-10
kNown_blood_pressure$ed_sbp_value[is.na(kNown_blood_pressure$ed_sbp_value)]<-999
#an ineffective way to ensure I don't get na:s in "ed_sbp_below_90" column below

kNown_blood_pressure$ed_sbp_below_90 <- with(kNown_blood_pressure, ifelse(ed_sbp_value>=0 & kNown_blood_pressure$ed_sbp_value<=90, TRUE, FALSE))
kNown_blood_pressure$shock <- with(kNown_blood_pressure, ifelse(ed_sbp_below_90 == TRUE | ed_sbp_rtscat <= 3, TRUE, FALSE))
#creating column for bp<90 with TRUE/FALSE

#GERIATRIC
kNown_age <- fewer_variables
kNown_age$geriatric <- with(fewer_variables, ifelse(pt_age_yrs>65, TRUE, FALSE))
#creating column in new df with TRUE/FALSE

#PENETRATING
neck_chest_abdomen_region <- function(code) {
  code <- code[!is.na(code)]
  region <- substr(as.character(code), 1, 1)  
  is.element(region,3:5)
}
#generates TRUE/FALSE

serious_neck_chest_abdomen_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  sum(neck_chest_abdomen_region(code[serious_injury]) == TRUE )
}
#generates numerical value

kNown_dominant_injury_pen <-fewer_variables[!is.na(fewer_variables$inj_dominant), ] 
kNown_dominant_injury_pen$penetrating <- NA
#removing na in dominant injury, new df

for (i in 1:nrow(kNown_dominant_injury_pen)) {
  v = 0+i
  if(serious_neck_chest_abdomen_injury(kNown_dominant_injury_pen[v,grepl( "AISCode" , names(kNown_dominant_injury_pen))]) >= 1 && kNown_dominant_injury_pen[v, "inj_dominant"] == 2) {
    kNown_dominant_injury_pen[v,"penetrating"] <- TRUE
  } else {
    kNown_dominant_injury_pen[v,"penetrating"] <- FALSE
  }
}
#penetrating <- TRUE/FALSE


#SEVERE TBI
head_region <- function(code) {
  region <- substr(as.character(code), 1, 1)
  is.element(region, 1)
}

#returns true if body region == 1

has_a_serious_head_injury <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  head_region(code[serious_injury]) 
}

#acts on vectors in "serious_injury", chooses those which have region == 1

only_one_region <- function(code){
  number_of_regions(code) == 1
}

#generates TRUE/FALSE

only_one_serious_injury_region <- function(code) {
  code <- code[!is.na(code)]
  serious_injury <- is_serious(code)
  only_one_region(code[serious_injury])
}
#generates TRUE/FALSE

gcs_and_intub_is_na <- with(fewer_variables, is.na(ed_gcs_sum) & is.na(pre_intub_type))    
kNown_gcs_or_intub_type <- fewer_variables[!gcs_and_intub_is_na,]  
#remove row if na in both prehospital intub type and gcs

kNown_gcs_or_intub_type$gcs_below_9 <- NA

kNown_gcs_or_intub_type$gcs_below_9 <- with(kNown_gcs_or_intub_type, ifelse(ed_gcs_sum<=8 | pre_intub_type==1, TRUE, FALSE))
kNown_gcs_or_intub_type$gcs_below_9 <- with(kNown_gcs_or_intub_type, ifelse(is.na(gcs_below_9) | isFALSE(gcs_below_9), FALSE, TRUE))

#makes new variable containing those with a GCS <9 and those intubated in a prehospital setting. Converts na to false

kNown_gcs_or_intub_type$severe_tbi <- NA

for (i in 1:nrow(kNown_gcs_or_intub_type)) {
  v = 0+i
if (has_a_serious_head_injury(kNown_gcs_or_intub_type[v, grepl("AISCode", names(kNown_gcs_or_intub_type))]) == TRUE && only_one_serious_injury_region(kNown_gcs_or_intub_type[v, grepl("AISCode", names(kNown_gcs_or_intub_type))]) == TRUE && kNown_gcs_or_intub_type[v, "gcs_below_9"] == TRUE) {
    kNown_gcs_or_intub_type[v,"severe_tbi"] <- TRUE
  } else {
    kNown_gcs_or_intub_type[v,"severe_tbi"] <- FALSE
  }
}


#### MERGING 

blunt_multisystem_cohort <- filter(kNown_dominant_injury, blunt_multisystem == "TRUE")
shock_cohort <- filter(kNown_blood_pressure, shock == "TRUE")
penetrating_cohort <- filter(kNown_dominant_injury_pen, penetrating == "TRUE")
geriatric_cohort <- filter(kNown_age, geriatric == "TRUE")
severe_tbi_cohort <-filter(kNown_gcs_or_intub_type, severe_tbi == "TRUE")
overall <- fewer_variables
#creating cohort df:s

 geriatric_cohort$Cohort <- "Geriatric"
 penetrating_cohort$Cohort <- "Penetrating"
 severe_tbi_cohort$Cohort <- "Severe TBI"
 shock_cohort$Cohort <- "Shock"
 blunt_multisystem_cohort$Cohort <- "Blunt multisystem"
 overall$Cohort <- "Overall"
 #creating common variable "cohort"
 
  merged_cohorts <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(geriatric_cohort, penetrating_cohort, blunt_multisystem_cohort, shock_cohort, severe_tbi_cohort, overall))

  #merging cohorts

  
  
  
#### PLOTTING
  
  ## FLOWCHARTS                  
            
  
  
                  
  #SweTrau to M&M                
                  
 swetrau_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot]

# Node definitions with substituted label text
Node [shape = rectangle, width = 4, fillcolor = Biege]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']


a -> b -> c -> d -> e -> f 



}

[1]:  paste0('Trauma team activation following major trauma')
[2]: paste0('Inclusion in SweTrau')
[3]: paste0('Primary review and audit filters')
[4]: paste0('Secondary review by trained nurse')
[5]: paste0('Multidisciplinary mortality and morbidity conference')
[6]: paste0('Consensus regarding existence of OFI')
")                
  
#Stages of exclusion  
                        
   a <- c(0,1)               
   a$a <- nrow(datasets$problem) 
   a <- as.data.frame(a)
   a$b <- nrow(kNown_problem_area)
   a$c <- nrow(age_over_14)
   a$d <- nrow(fewer_variables)
   a$e <- nrow(blunt_multisystem_cohort)
   a$f <- nrow(penetrating_cohort)
   a$g <- nrow(severe_tbi_cohort)
   a$h <- nrow(geriatric_cohort)
   a$i <- nrow(shock_cohort)
            
  #df with nrow of relevant df:s to be used as reference in code below 
   
exclusion_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot, ratio = compress, size=8]

Node [shape = rectangle, width = 4, fillcolor = Biege]
a [label = '@@1']
b [label = '@@2']
c [label = '@@3']
d [label = '@@4']
e [label = '@@5']
f [label = '@@6']
g [label = '@@7']
h [label = '@@8']
i [label = '@@9']

a -> b -> c -> d 
d-> e
d->f
d->g
d->h
d->i
          
}

[1]: paste0('Trauma care quality database (n = ', a$a, ')')
[2]: paste0('KNown problem area (n = ', a$b, ')')
[3]: paste0('Age ≥ 15 (n = ', a$c, ')')
[4]: paste0('Eligible for grouping stage (n = ', a$d, ')')
[5]: paste0('Blunt multisystem (n = ', a$e, ')')
[6]: paste0('Penetrating (n = ', a$f, ')')
[7]: paste0('Severe TBI (n = ', a$g, ')')
[8]: paste0('Geriatric (n = ', a$h, ')')
[9]: paste0('Shock (n = ', a$i, ')')


", height = "250")

   
#### GROUPING AND EXCLUSION TABLE
   
Cohort <- c("Blunt multisystem", "Penetrating", "Severe TBI", "Shock", "Geriatric")
Type <- c("Dominant Injury", "Dominant Injury", "ED GCS", "ED blood pressure", "Age")
Missing <- c((nrow(fewer_variables)-nrow(kNown_dominant_injury)),(nrow(fewer_variables)-nrow(kNown_dominant_injury)), (nrow(fewer_variables)-nrow(kNown_gcs_or_intub_type)), (nrow(fewer_variables)-nrow(kNown_blood_pressure)), (nrow(fewer_variables)-nrow(kNown_age)))
Missing_as_percent <- c( round(((nrow(fewer_variables)-nrow(kNown_dominant_injury))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(kNown_dominant_injury))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(kNown_gcs_or_intub_type))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(kNown_blood_pressure))/nrow(fewer_variables)*100), digits = 2), round(((nrow(fewer_variables)-nrow(kNown_age))/nrow(fewer_variables)*100), digits = 2))
   
Exclusion_table <- data.frame(Cohort, Type, Missing, Missing_as_percent)
Exclusion_table



   
   
 #### PATIENT DEMOGRAPHICS 
  
  merged_cohorts$NISS<- as.numeric(merged_cohorts$NISS)
                  render.continuous.default(merged_cohorts$NISS)
                  merged_cohorts$pt_age_yrs<- as.numeric(merged_cohorts$pt_age_yrs)
                  render.continuous.default(merged_cohorts$pt_age_yrs)

                  label(merged_cohorts$NISS)              <- "New Injury Severity Score"
                  label(merged_cohorts$ed_sbp_value)     <- "Emergency Department Systolic BP"
                  label(merged_cohorts$pt_age_yrs)        <- "Age"
                  label(merged_cohorts$OFI)               <- "Opportunities for improvement"
                  
    
              
                  units(merged_cohorts$ed_sbp_value)   <- "mmHg"
                  units(merged_cohorts$pt_age_yrs)    <-"Years"
                  

                  pt_demographics <- table1(~ OFI + pt_age_yrs + Gender + NISS  + ed_sbp_value | Cohort, data=merged_cohorts, caption = "Demographics", overall = FALSE)
 #Since cohorts are merged in a manner allowing for duplicates, the "overall" number will Not match the total number of participants, but instead the sum of the cohorts.  
                  
                  
                  
                  
                

#### INCIDENCE CALCULATIONS
   
                  
   fewer_variables$date <- as.Date(strptime(fewer_variables$arrival, format = "%Y%m%d %H:%M"))
#converting date               
                

### INCIDENCE (year)

cohorts <- list(geriatric_cohort = geriatric_cohort,
                 penetrating_cohort = penetrating_cohort,
                 blunt_multisystem_cohort = blunt_multisystem_cohort,
                 shock_cohort = shock_cohort,
                 severe_tbi_cohort = severe_tbi_cohort,
                 overall = overall)
 calculate_incidence <- function(cohort) {
     cohort.ofi <- incidence(cohort$arrival, interval = "year", groups = cohort$OFI) %>% as.data.frame()
     cohort.ofi$incidence <- 0
     if (is.element("No", names(cohort.ofi)))
         cohort.ofi$incidence <- cohort.ofi$Yes / (cohort.ofi$Yes + cohort.ofi$No) * 100
     return (cohort.ofi)
 }
 incidence.data <- lapply(cohorts, calculate_incidence)
class(cohorts$geriatric_cohort$arrival) 

### CUMULATIVE INCIDENCE (year)

 calculate_percent_of_total <- function(cohort) {
     cohort.ofi <- incidence(cohort$arrival, interval = "year", groups = cohort$OFI) %>% as.data.frame()
     cohort.ofi$per_tot <- 0
     if (is.element("No", names(cohort.ofi)))
         cohort.ofi$per_tot <- cohort.ofi$Yes / c(nrow(cohort)) * 100
     return (cohort.ofi)
 }
     
  percentage.data <- lapply(cohorts, calculate_percent_of_total)    
 
 get_cum_inc<- function(cohort){
cum_inc <- transform(cohort, cum_inc = cumsum(cohort$per_tot))
 return(cum_inc)
 }
 
cumulative.incidence.data <- lapply(percentage.data, get_cum_inc)
 




#### RENAMING VARIABLES

incidence_data <- incidence.data
incidence.data$geriatric_cohort$incidence_ger <- incidence.data$geriatric_cohort$incidence
incidence.data$penetrating_cohort$incidence_pen <- incidence.data$penetrating_cohort$incidence
incidence.data$severe_tbi_cohort$incidence_tbi <- incidence.data$severe_tbi_cohort$incidence
incidence.data$shock_cohort$incidence_sho <- incidence.data$shock_cohort$incidence
incidence.data$blunt_multisystem_cohort$incidence_blu <- incidence.data$blunt_multisystem_cohort$incidence
incidence.data$overall$incidence_all <- incidence.data$overall$incidence

#making unique variable name for each cohort (there surely is a way to do this more efficiently, but right Now it is Not my focus

cumulative.incidence.data$geriatric_cohort$cum_inc_ger <- cumulative.incidence.data$geriatric_cohort$cum_inc
cumulative.incidence.data$penetrating_cohort$cum_inc_pen <- cumulative.incidence.data$penetrating_cohort$cum_inc
cumulative.incidence.data$severe_tbi_cohort$cum_inc_tbi <- cumulative.incidence.data$severe_tbi_cohort$cum_inc
cumulative.incidence.data$shock_cohort$cum_inc_sho <- cumulative.incidence.data$shock_cohort$cum_inc
cumulative.incidence.data$blunt_multisystem_cohort$cum_inc_blu <- cumulative.incidence.data$blunt_multisystem_cohort$cum_inc
cumulative.incidence.data$overall$cum_inc_all <- cumulative.incidence.data$overall$cum_inc

#No2


cumulative.incidence.data <- bind_rows(cumulative.incidence.data, .id = NULL)
cumulative.incidence.data[is.na(cumulative.incidence.data)] = 0
cumulative.incidence.data<- ddply(cumulative.incidence.data,"dates",numcolwise(sum))
#list to df

incidence.data <- bind_rows(incidence.data, .id = NULL)
incidence.data[is.na(incidence.data)] = 0
incidence.data<- ddply(incidence.data,"dates",numcolwise(sum))
#list to df




#### PLOTTING INCIDENCE AND CUMULATIVE INCIDENCE

#Yearly incidence as %
plot_inc_year <- incidence.data %>% select(dates, incidence_ger, incidence_pen, incidence_blu, incidence_sho, incidence_tbi, incidence_all)

plot_inc_year_long <- melt(plot_inc_year, id.vars = "dates")
#melt as to enable ggplot to work

incidence_plot <- ggplot(plot_inc_year_long,
       aes(x=dates,
           y=value,
           col = variable)) + 
  scale_color_discrete(name = "Cohort", labels = c("Geriatric", "Penetrating", "Blunt multisystem", "Shock","Severe TBI", "Overall")) +
  geom_line(size = 1.0, alpha = 1.0) +
  labs(x = "Year",
       y = "% of year") +
  theme_tufte() +
  theme(axis.title = element_text(), legend.title = element_blank()) 

#Right Now Not showing S-TBI cohort as there are missing values.


#Cumulative incidence
plot_cum_inc<-cumulative.incidence.data %>% select(dates, cum_inc_ger, cum_inc_pen, cum_inc_blu, cum_inc_sho, cum_inc_tbi, cum_inc_all)

plot_cum_inc_long <- melt(plot_cum_inc, id.vars = "dates")

cum_incidence_plot<- ggplot(plot_cum_inc_long,
       aes(x=dates,
           y=value,
           col = variable)) +
  scale_color_discrete(name = "Cohort", labels = c("Geriatric", "Penetrating", "Blunt multisystem", "Shock","Severe TBI", "Overall")) +
  geom_line(size = 1.0, alpha = 1.0) +
  labs(x = "Year",
       y = "% of total") +
  theme_tufte() +
  theme(axis.title = element_text(), legend.title = element_blank())



#### REFERENCES FOR MARKDOWN CHUNKS

cum_inc <- select(plot_cum_inc, -dates)
cum_inc <- cum_inc %>% slice(-c(1:8))


incidence <- select(incidence.data, incidence_ger, incidence_pen, incidence_blu, incidence_sho, incidence_tbi)

min.col <- function(m, ...) max.col(-m, ...)


pt_demographics_flex<- t1flex(pt_demographics)

FitFlextableToPage <- function(ft, pgwidth = 6){
    ft_out <- ft %>% autofit()
      ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

pt_demographics_kable<- t1kable(pt_demographics)


library(broom)






#### INCIDENCE TRENDS

library(fable)

calculate_incidence_trends <- function(cohort) {
   trend <- as_tsibble(cohort) %>% model(lm = TSLM(incidence ~ trend() + season())) %>% tidy()
     return (trend)
}

incidence.data$geriatric_cohort$dates<- as.Date(incidence.data$geriatric_cohort$dates)
incidence.data$penetrating_cohort$dates<- as.Date(incidence.data$penetrating_cohort$dates)
incidence.data$blunt_multisystem_cohort$dates<- as.Date(incidence.data$blunt_multisystem_cohort$dates)
incidence.data$shock_cohort$dates<- as.Date(incidence.data$shock_cohort$dates)
incidence.data$severe_tbi_cohort$dates<- as.Date(incidence.data$severe_tbi_cohort$dates)



incidence.trends <- lapply(incidence.data, calculate_incidence_trends)

penetrating_incidence_trend <- as_tsibble(incidence_data$penetrating_cohort$dates, regular = FALSE) %>% model(lm = TSLM(incidence ~ trend() + season())) %>% tidy()


penetrating_incidence_trend <- incidence.trends$penetrating_cohort[c(2), ] 
geriatric_incidence_trend <- incidence.trends$geriatric_cohort[c(2), ] 
tbi_incidence_trend <- incidence.trends$severe_tbi_cohort[c(2), ] 
blunt_incidence_trend <- incidence.trends$blunt_multisystem_cohort[c(2), ] 
shock_incidence_trend <- incidence.trends$shock_cohort[c(2), ] 
overall_incidence_trend <- incidence.trends$overall[c(2), ] 


penetrating_incidence_trend$cohort <- "Penetrating"
geriatric_incidence_trend$cohort <-"Geriatric"
tbi_incidence_trend$cohort <- "Severe TBI"
blunt_incidence_trend$cohort <- "Blunt multisystem"
shock_incidence_trend$cohort <- "Shock"
overall_incidence_trend$cohort <- "Overall"

incidence_trend_table <- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(penetrating_incidence_trend, geriatric_incidence_trend, tbi_incidence_trend, blunt_incidence_trend, shock_incidence_trend, overall_incidence_trend))

library(dplyr)
library(readxl)

names(incidence_trend_table) <- c('Model', 'Term', 'Estimate', 'Cohort', 'SD_error', 'Statistic', 
                       'P_value')
incidence_trend_table <- incidence_trend_table[,c(4, 3, 5, 6, 7, 2, 1)]
incidence_trend_table <- incidence_trend_table[, -c(6,7)]

### GRAPH PRESENTING YEARLY M&M PARTICIPANTS AS % OF YEARLY SWETRAU PARTICIPANTS 

swetrau_scrambled_date <- swetrau_scrambled
swetrau_scrambled_date$date <-substr(as.character(swetrau_scrambled$DateTime_ArrivalAtHospital),1,10)
swetrau_scrambled_date$date <- as.Date(swetrau_scrambled_date$date)

swetrau_scrambled_date <- swetrau_scrambled_date %>% select(id, date)

swetrau_scrambled_date <- incidence(swetrau_scrambled_date$date, interval = "year")


problem_scrambled_date <- problem_scrambled
problem_scrambled_date$date <-as.Date(strptime(problem_scrambled_date$arrival, format = "%Y%m%d %H:%M"))
#converting date

problem_scrambled_date <- problem_scrambled_date %>% select(id, date)

problem_scrambled_date <- incidence(problem_scrambled_date$date, interval = "year")
do.call(rbind.data.frame, problem_scrambled_date)
do.call(rbind.data.frame, swetrau_scrambled_date)

problem_scrambled_date <- as.data.frame(problem_scrambled_date)
swetrau_scrambled_date <- as.data.frame(swetrau_scrambled_date)

problem_swetrau_percentage <- merge(problem_scrambled_date, swetrau_scrambled_date, by = "dates")

problem_swetrau_percentage$MM_percentage_of_swetrau <- problem_swetrau_percentage$counts.x/ problem_swetrau_percentage$counts.y *100

ggplot(problem_swetrau_percentage,
       aes(x=dates,
           y=MM_percentage_of_swetrau)) + 
  geom_line(size = 1.0, alpha = 1.0) +
  labs(title = "M&M as percent of SweTrau",
       x = "Year",
       y = "% of total") +
  theme_minimal() +
  theme(axis.title = element_text())

   
### INCIDENCE PACKAGE PLOT 

fewer_variables$date <- as.Date(strptime(fewer_variables$arrival, format = "%Y%m%d %H:%M"))
#converting date

incidence_package_ofi <- incidence(fewer_variables$date, interval = "year", groups = fewer_variables$OFI)
#Use of incidence package to calculate incidence in the group as a whole by year (2)

plot(incidence_package_ofi, stack = TRUE, border = "grey")
### TOTAL

#calculate incidence by cohort and year (2)
cohort_incidence_package_ofi <- filter(merged_cohorts, OFI == "Yes")

cohort_incidence_package_ofi$date <-as.Date(strptime(cohort_incidence_package_ofi$arrival, format = "%Y%m%d %H:%M"))
#converting date

#Since each case here is "OFI == Yes", incidence of dates is all we need to calculate

cohort_incidence_package_ofi <-incidence(cohort_incidence_package_ofi$date, interval = "year", groups = cohort_incidence_package_ofi$Cohort)

plot(cohort_incidence_package_ofi)
### BY COHORT


#####LINEAR REGRESSION
incidence.data$date<-c(1:9)

geriatric.data <- select(incidence.data, date, incidence_ger)
names(geriatric.data)[names(geriatric.data) == "date"] <- "Geriatric"
blunt.data <- select(incidence.data, date, incidence_blu)
names(blunt.data)[names(blunt.data) == "date"] <- "Blunt"
penetrating.data <- select(incidence.data, date, incidence_pen)
names(penetrating.data)[names(penetrating.data) == "date"] <- "Penetrating"
tbi.data <- select(incidence.data, date, incidence_tbi)
names(tbi.data)[names(tbi.data) == "date"] <- "TBI"
shock.data <- select(incidence.data, date, incidence_sho)
names(shock.data)[names(shock.data) == "date"] <- "Shock"
all.data <- select(incidence.data, date, incidence_all)
names(all.data)[names(all.data) == "date"] <- "All"


library(gtsummary)

linear_reg_all = lm(incidence_all~All, data = all.data)
tbl_all<- tbl_regression(linear_reg_all)
linear_reg_ger = lm(incidence_ger~Geriatric, data = geriatric.data)
tbl_ger <- tbl_regression(linear_reg_ger)
linear_reg_shock = lm(incidence_sho~Shock, data = shock.data)
tbl_shock <- tbl_regression(linear_reg_shock)
linear_reg_tbi = lm(incidence_tbi~TBI, data = tbi.data)
tbl_tbi <- tbl_regression(linear_reg_tbi)
linear_reg_blunt = lm(incidence_blu~Blunt, data = blunt.data)
tbl_blunt <- tbl_regression(linear_reg_blunt)
linear_reg_pen = lm(incidence_pen~Penetrating, data = penetrating.data)
tbl_pen <- tbl_regression(linear_reg_pen)

summary(linear_reg_all)

tbl_list<- list(all = tbl_all, blunt = tbl_blunt, penetrating = tbl_pen)
tbl_list_2 <- list(ger = tbl_ger, shock= tbl_shock, tbi= tbl_tbi)

merge_1<- tbl_merge(tbl_list)
merge_2 <- tbl_merge(tbl_list_2)

merged_list <- list(merge_1, merge_2)
merge_tot <- tbl_merge(merged_list)

incidence.trends <- lapply(incidence.data, calculate_incidence_trends)

tbl_summary(linear_reg_all)
linear_reg_all

`reg_all<- tidy(linear_reg_all, conf.int = TRUE)`
reg_blunt<- tidy(linear_reg_blunt, conf.int = TRUE)
reg_pen<- tidy(linear_reg_pen, conf.int = TRUE)
reg_tbi<- tidy(linear_reg_tbi, conf.int = TRUE)
reg_shock<- tidy(linear_reg_shock, conf.int = TRUE)
reg_ger<- tidy(linear_reg_ger, conf.int = TRUE)


regression_table<- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(reg_all, reg_blunt, reg_pen, reg_tbi, reg_shock, reg_ger))



regression_table <- subset(regression_table, term !="(Intercept)" )
names(regression_table) <- c('Cohort', 'Estimate', 'SDerror', 'Statistic', 'Pvalue', 'LowerBound', 
                       'UpperBound')
regression_table$LowerBound <- round(regression_table$LowerBound, digits= 4)
regression_table$UpperBound <- round(regression_table$UpperBound, digits= 4)

rownames(regression_table) <- c()
regression_table$CI <- paste(regression_table$LowerBound, regression_table$UpperBound, sep = "-")

regression_table <- select(regression_table, Cohort, Estimate,CI, Pvalue)

library(kableExtra)
library(dplyr)
regression_table %>%
   kbl(caption = "<strong>Table 3: Incidence trends.</strong>", col.names = c("Cohort","Estimate","95% CI", "P value")) %>%
  kable_classic_2(html_font = "Cambria") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "left")
 






### INCIDENCE PACKAGE PLOT 

fewer_variables$date <- as.Date(strptime(fewer_variables$Ankomst_te.x, format = "%Y%m%d %H:%M"))
#converting date

incidence_package_ofi <- incidence(fewer_variables$date, interval = "6 months", groups = fewer_variables$OFI)
#Use of incidence package to calculate incidence in the group as a whole by year (2)

plot(incidence_package_ofi, stack = TRUE, border = "grey")
### TOTAL

#calculate incidence by cohort and year (2)
cohort_incidence_package_ofi <- filter(merged_cohorts, OFI == "Yes")

cohort_incidence_package_ofi$date <-as.Date(strptime(cohort_incidence_package_ofi$Ankomst_te.x, format = "%Y%m%d %H:%M"))
#converting date

#Since each case here is "OFI == Yes", incidence of dates is all we need to calculate

cohort_incidence_package_ofi <-incidence(cohort_incidence_package_ofi$date, interval = "6 months", groups = cohort_incidence_package_ofi$Cohort)

plot(cohort_incidence_package_ofi)
### BY COHORT



#Manual calculation of confidence interval

geriatric_mean <- mean(geriatric_incidence$incidence)
geriatric_sd <- sd(geriatric_incidence$incidence)
geriatric_se <- geriatric_sd/sqrt(nrow(geriatric_incidence))
geriatric_alpha = 0.05
geriatric_degrees_of_freedom = (nrow(geriatric_incidence)) - 1
geriatric_t_score = qt(p=geriatric_alpha/2, df=geriatric_degrees_of_freedom,lower.tail=F)
geriatric_margin_error <- geriatric_t_score*geriatric_se
geriatric_lower_bound<-geriatric_mean-geriatric_margin_error
geriatric_upper_bound<-geriatric_mean+geriatric_margin_error




margin_error <- incidence_trend_table$Estimate * incidence_trend_table$P_value
lower_bound <- incidence_trend_table$Estimate + margin_error

#####LINEAR REGRESSION
incidence.data$date<-c(1:9)

geriatric.data <- select(incidence.data, date, incidence_ger)
names(geriatric.data)[names(geriatric.data) == "date"] <- "Geriatric"
blunt.data <- select(incidence.data, date, incidence_blu)
names(blunt.data)[names(blunt.data) == "date"] <- "Blunt"
penetrating.data <- select(incidence.data, date, incidence_pen)
names(penetrating.data)[names(penetrating.data) == "date"] <- "Penetrating"
tbi.data <- select(incidence.data, date, incidence_tbi)
names(tbi.data)[names(tbi.data) == "date"] <- "TBI"
shock.data <- select(incidence.data, date, incidence_sho)
names(shock.data)[names(shock.data) == "date"] <- "Shock"
all.data <- select(incidence.data, date, incidence_all)
names(all.data)[names(all.data) == "date"] <- "All"


library(gtsummary)

linear_reg_all = lm(incidence_all~All, data = all.data)
tbl_all<- tbl_regression(linear_reg_all)
linear_reg_ger = lm(incidence_ger~Geriatric, data = geriatric.data)
tbl_ger <- tbl_regression(linear_reg_ger)
linear_reg_shock = lm(incidence_sho~Shock, data = shock.data)
tbl_shock <- tbl_regression(linear_reg_shock)
linear_reg_tbi = lm(incidence_tbi~TBI, data = tbi.data)
tbl_tbi <- tbl_regression(linear_reg_tbi)
linear_reg_blunt = lm(incidence_blu~Blunt, data = blunt.data)
tbl_blunt <- tbl_regression(linear_reg_blunt)
linear_reg_pen = lm(incidence_pen~Penetrating, data = penetrating.data)
tbl_pen <- tbl_regression(linear_reg_pen)

summary(linear_reg_all)

tbl_list<- list(all = tbl_all, blunt = tbl_blunt, penetrating = tbl_pen)
tbl_list_2 <- list(ger = tbl_ger, shock= tbl_shock, tbi= tbl_tbi)

merge_1<- tbl_merge(tbl_list)
merge_2 <- tbl_merge(tbl_list_2)

merged_list <- list(merge_1, merge_2)
merge_tot <- tbl_merge(merged_list)


reg_all<- tidy(linear_reg_all, conf.int = TRUE)
reg_blunt<- tidy(linear_reg_blunt, conf.int = TRUE)
reg_pen<- tidy(linear_reg_pen, conf.int = TRUE)
reg_tbi<- tidy(linear_reg_tbi, conf.int = TRUE)
reg_shock<- tidy(linear_reg_shock, conf.int = TRUE)
reg_ger<- tidy(linear_reg_ger, conf.int = TRUE)

regression_table<- Reduce(function(x, y) merge(x, y, all=TRUE),
                                     list(reg_all, reg_blunt, reg_pen, reg_tbi, reg_shock, reg_ger))



regression_table <- subset(regression_table, term !="(Intercept)" )
names(regression_table) <- c('Cohort', 'Estimate', 'SDerror', 'Statistic', 'Pvalue', 'LowerBound', 
                       'UpperBound')
regression_table$LowerBound <- round(regression_table$LowerBound, digits= 4)
regression_table$UpperBound <- round(regression_table$UpperBound, digits= 4)

rownames(regression_table) <- c()
regression_table$CI <- paste(regression_table$LowerBound, regression_table$UpperBound, sep = "-")

regression_table <- select(regression_table, Cohort, Estimate,CI, Pvalue)

library(kableExtra)
library(dplyr)
regression_table_knit<- regression_table %>%
   kbl(caption = "<strong>Table 3: Incidence trends.</strong>", col.names = c("Cohort","Estimate","95% CI", "P value")) %>%
  kable_classic_2(html_font = "Cambria") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "left")
 


exclusion_flowchart <- DiagrammeR::grViz("
digraph graph2 {

graph [layout = dot, size=30, ranksep = 2 nodesep = 2]

node [shape = rectangle, height = 2, width = 12, fillcolor = Biege, fontsize = 50, penwidth =6, arrowsize = .5, weight = 2]
a [label = '@@1']
b [label = '@@2']
d [label = '@@3', arrowhead = none]
e [label = '@@4']
f [label = '@@5']
g [label = '@@6']
h [label = '@@7']
i [label = '@@8']
j [label = '@@9']
k [label = '@@10']
m [label = '@@11', style = dotted, arrowhead = none]
n [label = '@@12', style = dotted, arrowhead = none]
o [label = '@@13', style = dotted, arrowhead = none]
p [label = '@@14', style = dotted, arrowhead = none] 
q [label = '@@15', style = dotted, arrowhead = none]
c [label = '@@15']

a -> b 
a -> j
b -> d
b -> k
d -> c
d-> {m n o p q}
m -> e
n -> f
o -> g
p -> h 
q -> i

{ rank = same; a; j }
{ rank = same; b; k }
{ rank = same; d; c }
 
          
}

[1]: paste0('Trauma care quality database (n = ', a$a, ')')
[2]: paste0('ED arrival after 2017-01-01 (n = ', a$b, ')')
[3]: paste0('Eligible for grouping stage (n = ', a$d, ')')
[4]: paste0('Blunt multisystem (n = ', a$e, ')')
[5]: paste0('Penetrating (n = ', a$f, ')')
[6]: paste0('Severe TBI (n = ', a$g, ')')
[7]: paste0('Shock (n = ', a$i, ')')
[8]: paste0('Geriatric (n = ', a$h, ')')
[9]: paste0('Insufficient data regarding OFI (n = ', (a$a - a$b), ')')
[10]: paste0('Age below 15 (n = 18)')
[11]: paste0('Unknown dominant injury (n = 0)')
[12]: paste0('Unknown dominant injury (n = 0)')
[13]: paste0('Unknown ED GCS (n = 159)')
[14]: paste0('Unknown ED SBP (n = 9)')
[15]: paste0('Unknown age (n = 0)')
[16]: paste0('\\textbf{Missing data by cohort} /pBlunt multisystem: dominant injury type /p Penetrating: dominant injury type /p Severe TBI: ED GCS /pShock: ED SBP /pGeriatric: age  ED SBP (n = 9)')
", height = "500") %>% DiagrammeRsvg::export_svg() %>% charToRaw() %>% rsvg::rsvg_pdf("exclusion_flowchart.pdf")   




```


# Background

## Preventable deaths
In trauma epidemiology, deaths by trauma are often divided into one of three categories: non-preventable, potentially preventable, or preventable. [@Preventable_1, @Preventable_2]. For a death to be labeled preventable, its avoidability must first be determined. There are three criteria for a traumatic death to be labeled avoidable: (i) the patient must have survived initial traumatic injuries and its consequences, (ii) the care of the patient cannot have been in accordance with treatment guidelines and (iii) errors in patient care must be related- or indirectly related to the patients death[@Avoidable]. Difficulty arises in individual assessment of the relationship between inappropriate care and avoidable deaths. Partly as a result, studies that aim to estimate the percentage of preventable and potentially preventable in-hospital deaths, have reached vastly different results, ranging from 2,5% to 76% [@Preventable_1, @Preventable_2, @Preventable_5, @Preventable_3, @Preventable_6]. The term “opportunities for improvement” (OFI) in patient care, independent of injury severity or death avoidability, gives a more accurate estimation of sub optimal care rendered and identifies negative trends that may be rectified by the implementation of corrective initiatives. Moreover, it relieves review boards from the troublesome implication of labeling care “inappropriate”[@Preventable_6].

## Cohorts
Studies investigating trauma care often divide patients into cohorts, defined by mechanism of injury, severity of injury or patient group belonging. ACS TQIP advocates for the grouping of trauma patients by the Abbreviated Injury Scale (AIS) grading system, which forms a number of seven digits indicating (i) region of injury, (ii) type of anatomical structure, (iii) specific anatomical structure, (iv) level of injury and (v) severity of injury[@TQIP][@AIS]. This study investigate five of the cohorts used in the ACS TQIP: blunt multisystem; penetrating truncal; shock; severe traumatic brain injury (TBI) and geriatric[@QualityBenchmarking]. Blunt multisystem and penetrating truncal are chosen as they are the two major mechanisms of injury resulting in traumatic death[@Trauma]. Shock, due to hemorrhage or neurological dysfunction, and severe traumatic brain injury are the two trauma-induced conditions most likely to result in traumatic death[@TBI_Shock]. The geriatric patient group is included as it is one less prone to recovery and one whose care differ significantly from that of the younger age groups[@Trauma]. Furthermore, the decision to study these cohorts was one taken in accordance with local directives, limitations to the data contained in SweTrau and KUH TCQD and the time and resources dedicated to this project.


# Results
## Participants 
Over the pre-specified study period, `r nrow(datasets$problem)` patients was included in the the trauma care quality database. Of those, `r nrow(fewer_variables)` (`r nrow(fewer_variables)/nrow(datasets$problem)*100`%) patients had sufficient data for grouping into cohorts and went on to form the study population (see Figure 1). Participants were then divided into the five cohorts blunt multisystem (n=`r nrow(blunt_multisystem_cohort)`), geriatric (n=`r nrow(geriatric_cohort)`), penetrating (n= `r nrow(penetrating_cohort)`), severe TBI (n=`r nrow(severe_tbi_cohort)`) and shock (n=`r  nrow(shock_cohort)`). `r Exclusion_table$Missing[1]` patients lacked data about dominant injury type; `r Exclusion_table$Missing[3]` patients lacked data about emergency department gcs; `r Exclusion_table$Missing[4]` patients lacked data about emergency department blood pressure. No patients lacked data about age (see Table 1).

```{r echo=FALSE, warning=FALSE}

  exclusion_flowchart


```


Figure 1: Exclusion flowchart. Excluded are patients with missing data in the problem area variable and patients aged 14 and below. TBI: traumatic brain injury.



```{r echo=FALSE, warning=FALSE}
library(dplyr)
library(kableExtra)
Exclusion_table %>%
   kbl(caption = "Missing data by cohort. In table 1, the variable `Missing` refers to the number of patients lacking sufficient data for grouping into a specified cohort.", col.names = c("Cohort","Type",
                           "Missing",
                           "%")) %>%
  kable_classic_2(html_font = "Cambria") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "left")



```

 
## Descriptive data
Table 2 presents patient demographics in the trauma cohorts. The cohorts exhibited differences regarding age, injury severity score, emergency department systolic BP, (insert extra variables). The cohort with the highest percentage of OFI was `r colnames(cum_inc)[apply(cum_inc,1,which.max)]` with `r round(max(cum_inc), digits=2)`%. The cohort with the lowest percentage of OFI was `r colnames(cum_inc)[apply(cum_inc,1,which.min)]` with `r round(min(cum_inc), digits=2)`%.




```{r echo=FALSE, warning=FALSE}
library(dplyr)
library(kableExtra)
pt_demographics_kable %>%
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "left")%>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "scale_down")

```
SD: standard deviation, BP: blood pressure.



## Incidence
In the study population, total incidence of OFI ranged from  `r round(min(incidence.data$incidence_all), digits=2)`% to   `r round(max(incidence.data$incidence_all), digits=2)`% (see Figure 2). The highest recorded yearly incidence was `r round(max(incidence), digits=2)`% in the `r colnames(incidence)[apply(cum_inc,1,which.max)]` cohort. Overall, there was a narrow/wide distribution of incidence of OFI across cohorts. The cumulative incidence rate varied significantly between cohorts. The cohort with the largest cumulative incidence was `r colnames(cum_inc)[apply(cum_inc,1,which.max)]` (`r round(max(cum_inc), digits=2)`%)  and the cohort with the lowest was `r colnames(cum_inc)[apply(cum_inc,1,which.min)]` (`r round(min(cum_inc), digits=2)`%). The cumulative incidence in the population as a whole was `r round(max(cum_inc$cum_inc_all), digits=2)`%.

```{r echo=FALSE, warning = FALSE}
library(ggplot2)
incidence_plot
```

Figure 2: Yearly incidence of OFI.
Percentage of yearly cohort participants with OFI. OFI: opportunities for improvement, TBI: traumatic brain injury.




```{r echo=FALSE, warning = FALSE}
library(ggplot2)
cum_incidence_plot
```

Figure 3: Cumulative incidence of OFI.
Cumulative percentage of total cohort participants with OFI.
OFI: opportunities for improvement, TBI: traumatic brain injury.

## Trends
The three most significant points of the "Incidence trends" table are highly contingent on the results. I could for instance write an advanced ifelse function where it "if TRUE", prints "downtrend" or "if FALSE" prints "uptrend" in "The cohort with the most significant downtrend was XXX with an estimate of X and a p-value of X,XX...", but it seems excessive. Perhaps it is just me experiencing a failure of imagination. 




TBI: traumatic brain injury.


```{r exclusion-table, echo=FALSE, warning=FALSE, message = FALSE}
library(kableExtra)

Exclusion_table %>%
   kbl(caption = "\\textbf{Missing data by cohort.} In table 1, the variable \\emph{Type} refers to the category of data required to group patients into a specified cohort. \\emph{Missing} refers to the number of patients lacking sufficient data in said category", col.names = c("Cohort","Type",
                           "Missing",
                           "%")) %>%
  kable_classic_2(html_font = "Cambria") %>%
  row_spec(0, bold= TRUE) %>%
  kable_styling(latex_options = "HOLD_position", full_width = F, position = "center")

incidence.data$numbers <- c(1:9)
model <- lm(incidence_blu ~ numbers, data=incidence.data)


```
*ED SBP: emergency department systolic blood pressure, ED GCS: emergency department Glasgow coma scale sum.*
At present, while there are a number of qualitative studies examining OFI in trauma care, few quantitative studies with objectives similar to those of this study, have been conducted. Two qualitative studies, one estimating OFI among patients demised due to mechanical trauma and the other for death by trauma in general, found OFI-percentages of 76% and 34% respectively[@QuantOFI; @OFI]. Since these studies estimate OFI in demised patients, their results are difficult to compare to the results in this study. One would expect the percentage to be higher in deceased patients, than in our study population. 

